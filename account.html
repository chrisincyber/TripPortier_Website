<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/cookie-consent.css">
    <script src="js/cookie-consent.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage your TripPortier account - view profile, settings, and sign out.">
    <title>My Account - TripPortier</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .account-page {
            min-height: 100vh;
            background: var(--theme-bg);
        }

        .account-header {
            background: var(--theme-hero-gradient);
            padding: 8rem 2rem 4rem;
            color: white;
            text-align: center;
        }

        .account-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .account-header p {
            opacity: 0.9;
            font-size: 1.125rem;
        }

        .account-content {
            max-width: 600px;
            margin: -3rem auto 4rem;
            padding: 0 1.5rem;
        }

        .account-card {
            background: var(--theme-card-bg, white);
            border-radius: 20px;
            box-shadow: var(--theme-card-shadow, 0 10px 40px rgba(0, 0, 0, 0.1));
            overflow: hidden;
        }

        .account-profile {
            padding: 2.5rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .account-avatar-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0 auto 1.5rem;
        }

        .account-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-text, #1e293b);
            margin-bottom: 0.25rem;
        }

        .account-email {
            color: var(--theme-text-secondary, #64748b);
            font-size: 1rem;
        }

        .account-info {
            padding: 1.5rem 2rem;
        }

        .account-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--theme-border, #f1f5f9);
        }

        .account-info-row:last-child {
            border-bottom: none;
        }

        .account-info-label {
            color: var(--theme-text-secondary, #64748b);
            font-size: 0.9375rem;
        }

        .account-info-value {
            color: var(--theme-text, #1e293b);
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .account-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            margin-bottom: 0.75rem;
        }

        .account-btn:last-child {
            margin-bottom: 0;
        }

        .account-btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .account-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .account-btn-secondary {
            background: var(--theme-bg-secondary, #f1f5f9);
            color: var(--theme-text-secondary, #475569);
        }

        .account-btn-secondary:hover {
            background: var(--theme-bg-tertiary, #e2e8f0);
        }

        .account-btn-danger {
            background: #fef2f2;
            color: #dc2626;
        }

        .account-btn-danger:hover {
            background: #fee2e2;
        }

        .account-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Loading state */
        .account-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .account-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Not logged in state */
        .account-guest {
            padding: 4rem 2rem;
            text-align: center;
        }

        .account-guest-icon {
            width: 80px;
            height: 80px;
            background: var(--theme-bg-secondary, #f1f5f9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .account-guest-icon svg {
            width: 40px;
            height: 40px;
            color: var(--theme-text-muted, #94a3b8);
        }

        .account-guest h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--theme-text, #1e293b);
            margin-bottom: 0.5rem;
        }

        .account-guest p {
            color: var(--theme-text-secondary, #64748b);
            margin-bottom: 2rem;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        /* App promo */
        /* Cashback Card */
        .cashback-card {
            background: var(--theme-card-bg, white);
            border-radius: 20px;
            box-shadow: var(--theme-card-shadow, 0 10px 40px rgba(0, 0, 0, 0.1));
            margin-top: 1.5rem;
            overflow: hidden;
        }

        .cashback-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 1.5rem 2rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cashback-balance {
            font-size: 2rem;
            font-weight: 700;
        }

        .cashback-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .cashback-level {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .cashback-info {
            padding: 1.5rem 2rem;
        }

        .cashback-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--theme-border, #f1f5f9);
        }

        .cashback-row:last-child {
            border-bottom: none;
        }

        .cashback-row-label {
            color: var(--theme-text-secondary, #64748b);
            font-size: 0.9375rem;
        }

        .cashback-row-value {
            color: var(--theme-text, #1e293b);
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .cashback-progress {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--theme-border, #e2e8f0);
        }

        .cashback-progress-label {
            font-size: 0.8125rem;
            color: var(--theme-text-secondary, #64748b);
            margin-bottom: 0.5rem;
        }

        .cashback-progress-bar {
            height: 8px;
            background: var(--theme-bg-tertiary, #e2e8f0);
            border-radius: 4px;
            overflow: hidden;
        }

        .cashback-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .cashback-referral {
            background: var(--theme-bg-secondary, #f8fafc);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .cashback-referral-code {
            font-family: monospace;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--theme-primary, #6366f1);
            letter-spacing: 0.1em;
        }

        .cashback-copy-btn {
            background: var(--theme-primary, #6366f1);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cashback-copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Subscription Section */
        .subscription-section {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--theme-border, #e2e8f0);
        }

        .subscription-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--theme-text-secondary, #64748b);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .subscription-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--theme-bg-secondary, #f8fafc);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .subscription-status.active {
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
        }

        .subscription-status-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .subscription-status-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .subscription-status-icon.free {
            background: var(--theme-bg-tertiary, #e2e8f0);
        }

        .subscription-status-icon.free svg {
            color: var(--theme-text-muted, #94a3b8);
        }

        .subscription-status-icon.premium {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .subscription-status-icon.premium svg {
            color: white;
        }

        .subscription-status-icon svg {
            width: 20px;
            height: 20px;
        }

        .subscription-status-text h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            margin: 0 0 0.125rem;
        }

        .subscription-status-text p {
            font-size: 0.8125rem;
            color: var(--theme-text-secondary, #64748b);
            margin: 0;
        }

        .subscription-status-text.active h4 {
            color: #166534;
        }

        .subscription-status-text.active p {
            color: #15803d;
        }

        .subscription-upgrade-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subscription-upgrade-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .app-promo {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            color: white;
            text-align: center;
        }

        .app-promo h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .app-promo p {
            opacity: 0.8;
            font-size: 0.9375rem;
            margin-bottom: 1.5rem;
        }

        .app-promo-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: white;
            color: #1e1b4b;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            transition: transform 0.2s ease;
        }

        .app-promo-btn:hover {
            transform: translateY(-2px);
        }

        /* Avatar Edit Button */
        .account-avatar-wrapper {
            position: relative;
            display: inline-block;
        }

        /* Account Settings Section */
        .account-settings {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-settings h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--theme-text-secondary, #64748b);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .account-setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--theme-bg-secondary, #f8fafc);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .account-setting-item:hover {
            background: var(--theme-bg-tertiary, #e2e8f0);
        }

        .account-setting-item:last-child {
            margin-bottom: 0;
        }

        .account-setting-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .account-setting-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--theme-primary, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .account-setting-icon svg {
            width: 20px;
            height: 20px;
        }

        .account-setting-text h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            margin: 0 0 0.125rem;
        }

        .account-setting-text p {
            font-size: 0.8125rem;
            color: var(--theme-text-secondary, #64748b);
            margin: 0;
        }

        .account-setting-arrow {
            color: var(--theme-text-muted, #94a3b8);
        }

        .account-setting-arrow svg {
            width: 20px;
            height: 20px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--theme-bg-tertiary, #cbd5e1);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Edit Profile Modal */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .edit-modal-content {
            position: relative;
            background: var(--theme-bg, white);
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .edit-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--theme-text, #1e293b);
            margin: 0;
        }

        .edit-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--theme-bg-secondary, #f1f5f9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--theme-text-secondary, #64748b);
            transition: all 0.2s;
        }

        .edit-modal-close:hover {
            background: var(--theme-bg-tertiary, #e2e8f0);
            color: var(--theme-text, #1e293b);
        }

        .edit-modal-body {
            padding: 1.5rem;
        }

        .edit-avatar-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .edit-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            overflow: hidden;
            background: var(--theme-bg-secondary, #f1f5f9);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .edit-avatar-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--theme-bg-secondary, #f1f5f9);
            color: var(--theme-primary, #6366f1);
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-avatar-btn:hover {
            background: var(--theme-bg-tertiary, #e2e8f0);
        }

        .edit-form-group {
            margin-bottom: 1.25rem;
        }

        .edit-form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--theme-text-secondary, #64748b);
            margin-bottom: 0.5rem;
        }

        .edit-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--theme-border, #e2e8f0);
            border-radius: 10px;
            font-size: 1rem;
            color: var(--theme-text, #1e293b);
            background: var(--theme-bg, white);
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .edit-form-group input:focus {
            outline: none;
            border-color: var(--theme-primary, #6366f1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .edit-modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            gap: 0.75rem;
        }

        .edit-modal-footer button {
            flex: 1;
            padding: 0.875rem;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .edit-cancel-btn {
            background: var(--theme-bg-secondary, #f1f5f9);
            color: var(--theme-text-secondary, #64748b);
        }

        .edit-cancel-btn:hover {
            background: var(--theme-bg-tertiary, #e2e8f0);
        }

        .edit-save-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .edit-save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .edit-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .edit-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .edit-error.show {
            display: block;
        }

        /* Profile Setup Step Dots */
        .setup-step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--theme-bg-tertiary, #e2e8f0);
            transition: all 0.3s ease;
        }

        .setup-step-dot.active {
            background: var(--theme-primary, #6366f1);
            transform: scale(1.2);
        }

        .setup-step-dot.completed {
            background: #22c55e;
        }

        @media (max-width: 600px) {
            .account-header {
                padding: 6rem 1.5rem 3rem;
            }

            .account-header h1 {
                font-size: 2rem;
            }

            .account-content {
                margin-top: -2rem;
            }

            .account-profile {
                padding: 2rem 1.5rem;
            }

            .account-info,
            .account-actions {
                padding: 1.25rem 1.5rem;
            }
        }

        /* Referral Code Section */
        .account-referral {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-referral h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .account-referral h3 svg {
            width: 20px;
            height: 20px;
            color: #8b5cf6;
        }

        .referral-code-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--theme-bg-secondary, #f8fafc);
            padding: 1rem;
            border-radius: 12px;
        }

        .referral-code {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--theme-text, #1e293b);
            flex: 1;
        }

        .referral-copy-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .referral-copy-btn:hover {
            background: #4f46e5;
        }

        .referral-description {
            font-size: 0.875rem;
            color: var(--theme-text-secondary, #64748b);
            margin-top: 0.75rem;
        }

        /* Friends Section */
        .account-friends {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-friends h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .account-friends h3 svg {
            width: 20px;
            height: 20px;
            color: #10b981;
        }

        .friends-count-badge {
            background: #6366f1;
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            margin-left: 0.5rem;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--theme-bg-secondary, #f8fafc);
            border-radius: 12px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            font-size: 0.9375rem;
        }

        .friend-username {
            font-size: 0.8125rem;
            color: var(--theme-text-secondary, #64748b);
        }

        .friend-remove-btn {
            background: none;
            border: none;
            color: var(--theme-text-secondary, #64748b);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .friend-remove-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .friends-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--theme-text-secondary, #64748b);
        }

        .add-friend-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--theme-bg-secondary, #f8fafc);
            border: 2px dashed var(--theme-border, #e2e8f0);
            border-radius: 12px;
            color: var(--theme-text-secondary, #64748b);
            font-size: 0.9375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .add-friend-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        /* User Preferences Section */
        .account-preferences {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
        }

        .account-preferences h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--theme-text, #1e293b);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .account-preferences h3 svg {
            width: 20px;
            height: 20px;
            color: #f59e0b;
        }

        .preference-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 0;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
        }

        .preference-item:last-child {
            border-bottom: none;
        }

        .preference-label {
            font-size: 0.9375rem;
            color: var(--theme-text, #1e293b);
        }

        .preference-value {
            font-size: 0.9375rem;
            color: var(--theme-text-secondary, #64748b);
        }

        .preference-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--theme-border, #e2e8f0);
            border-radius: 8px;
            background: var(--theme-bg, white);
            color: var(--theme-text, #1e293b);
            font-size: 0.875rem;
        }

        .passports-display {
            display: flex;
            gap: 0.25rem;
            font-size: 1.25rem;
        }

        /* Add Friend Modal */
        .add-friend-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .add-friend-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-friend-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .add-friend-modal-content {
            position: relative;
            background: var(--theme-card-bg, white);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
        }

        .add-friend-modal h3 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        .add-friend-input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--theme-border, #e2e8f0);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .add-friend-error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .add-friend-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .add-friend-cancel {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--theme-border, #e2e8f0);
            background: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .add-friend-submit {
            flex: 1;
            padding: 0.75rem;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Passports Modal */
        .passports-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .passports-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .passports-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .passports-modal-content {
            position: relative;
            background: var(--theme-card-bg, white);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .passports-modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--theme-border, #e2e8f0);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .passports-modal-header h3 {
            font-size: 1.125rem;
            margin: 0;
        }

        .passports-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--theme-text-secondary);
        }

        .passports-modal-body {
            padding: 1rem 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .passports-search {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--theme-border, #e2e8f0);
            border-radius: 10px;
            font-size: 0.9375rem;
            margin-bottom: 1rem;
        }

        .passports-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .passport-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .passport-item:hover {
            background: var(--theme-bg-secondary, #f8fafc);
        }

        .passport-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }

        .passport-item .flag {
            font-size: 1.25rem;
        }

        .passport-item .name {
            flex: 1;
            font-size: 0.9375rem;
        }

        .passports-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--theme-border, #e2e8f0);
            display: flex;
            gap: 0.75rem;
        }

        .passports-cancel-btn {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--theme-border, #e2e8f0);
            background: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9375rem;
        }

        .passports-save-btn {
            flex: 1;
            padding: 0.75rem;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .passports-save-btn:hover {
            background: #4f46e5;
        }
    </style>
</head>
<body class="account-page">
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="TripPortier Logo">
                TripPortier
            </a>
            <ul class="nav-links">
                <li><a href="esim.html">eSIM</a></li>
                <li class="nav-dropdown">
                    <a href="#" class="dropdown-toggle">Transport <span class="dropdown-arrow">▼</span></a>
                    <ul class="dropdown-menu">
                        <li><a href="airport-transfers.html">Airport Transfers</a></li>
                        <li><a href="https://asiatransport.tripportier.com" target="_blank">Asia Transport</a></li>
                    </ul>
                </li>
                <li id="mytrips-nav" style="display: none;"><a href="trips.html">My Trips</a></li>
                <li id="premium-nav"><a href="premium.html">TripPortier+</a></li>
            </ul>

            <button class="mobile-menu" onclick="toggleMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Account Header -->
    <header class="account-header">
        <h1>My Account</h1>
        <p>Manage your TripPortier profile</p>
    </header>

    <!-- Account Content -->
    <main class="account-content">
        <div class="account-card" id="account-card">
            <!-- Loading State (shown initially) -->
            <div class="account-loading" id="account-loading">
                <div class="account-loading-spinner"></div>
                <p style="color: #64748b;">Loading your account...</p>
            </div>

            <!-- Guest State (shown when not logged in) -->
            <div class="account-guest" id="account-guest" style="display: none;">
                <div class="account-guest-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h2>Sign in to continue</h2>
                <p>Create an account or sign in to access your profile and sync your data across devices.</p>
                <button class="account-btn account-btn-primary" onclick="window.authUI.showModal('signin')">
                    Sign In
                </button>
            </div>

            <!-- Logged In State -->
            <div id="account-content" style="display: none;">
                <div class="account-profile">
                    <div id="account-avatar-container" class="account-avatar-wrapper"></div>
                    <div class="account-name" id="account-name">-</div>
                    <div class="account-username" id="account-username" style="color: var(--theme-primary, #6366f1); font-size: 0.9375rem; margin-bottom: 0.25rem;">@username</div>
                    <div class="account-email" id="account-email">-</div>
                </div>

                <div class="account-info">
                    <div class="account-info-row">
                        <span class="account-info-label">Member since</span>
                        <span class="account-info-value" id="account-member-since">-</span>
                    </div>
                    <div class="account-info-row">
                        <span class="account-info-label">Account ID</span>
                        <span class="account-info-value" id="account-uid" style="font-family: monospace; font-size: 0.8rem;">-</span>
                    </div>
                </div>

                <!-- Subscription Section -->
                <div class="subscription-section" id="subscription-section">
                    <h3>Subscription</h3>
                    <div class="subscription-status" id="subscription-status">
                        <div class="subscription-status-info">
                            <div class="subscription-status-icon free" id="subscription-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            </div>
                            <div class="subscription-status-text" id="subscription-text">
                                <h4 id="subscription-plan-name">Free Plan</h4>
                                <p id="subscription-details">Upgrade to unlock all features</p>
                            </div>
                        </div>
                        <a href="premium.html" class="subscription-upgrade-btn" id="subscription-action">
                            Upgrade
                        </a>
                    </div>
                </div>

                <!-- Referral Code -->
                <div class="account-referral">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5v-8.25M12 4.875A2.625 2.625 0 109.375 7.5H12m0-2.625V7.5m0-2.625A2.625 2.625 0 1114.625 7.5H12m0 0V21m-8.625-9.75h18c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125h-18c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/>
                        </svg>
                        Referral Code
                    </h3>
                    <div class="referral-code-container">
                        <span class="referral-code" id="referral-code">--------</span>
                        <button class="referral-copy-btn" onclick="copyReferralCode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <p class="referral-description">Share your code and earn $3 for each friend who purchases an eSIM!</p>
                </div>

                <!-- User Preferences -->
                <div class="account-preferences">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/>
                        </svg>
                        User Preferences
                    </h3>
                    <div class="preference-item">
                        <span class="preference-label">Home Country</span>
                        <select class="preference-select" id="pref-home-country" onchange="saveUserPreference('homeCountry', this.value)">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="preference-item">
                        <span class="preference-label">Passports</span>
                        <div class="passports-display" id="pref-passports-display">
                            <button onclick="openPassportsModal()" style="background: none; border: 1px solid var(--theme-border); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">
                                Add passports
                            </button>
                        </div>
                    </div>
                    <div class="preference-item">
                        <span class="preference-label">Temperature Unit</span>
                        <select class="preference-select" id="pref-temperature-unit" onchange="saveUserPreference('temperatureUnit', this.value)">
                            <option value="celsius">Celsius (°C)</option>
                            <option value="fahrenheit">Fahrenheit (°F)</option>
                        </select>
                    </div>
                </div>

                <!-- Friends -->
                <div class="account-friends">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/>
                        </svg>
                        Friends
                        <span class="friends-count-badge" id="friends-count" style="display: none;">0</span>
                    </h3>
                    <div class="friends-list" id="friends-list">
                        <!-- Populated by JS -->
                    </div>
                    <div class="friends-empty" id="friends-empty">
                        <p>No friends yet</p>
                    </div>
                    <button class="add-friend-btn" onclick="openAddFriendModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                        </svg>
                        Add Friend
                    </button>
                </div>

                <!-- Account Settings -->
                <div class="account-settings">
                    <h3>Account Settings</h3>
                    <div class="account-setting-item" onclick="openEditProfile()">
                        <div class="account-setting-info">
                            <div class="account-setting-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                                </svg>
                            </div>
                            <div class="account-setting-text">
                                <h4>Edit Profile</h4>
                                <p>Change name and photo</p>
                            </div>
                        </div>
                        <div class="account-setting-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                            </svg>
                        </div>
                    </div>
                    <div class="account-setting-item" onclick="openChangeEmail()">
                        <div class="account-setting-info">
                            <div class="account-setting-icon" style="background: #10b981;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/>
                                </svg>
                            </div>
                            <div class="account-setting-text">
                                <h4>Change Email</h4>
                                <p>Update your email address</p>
                            </div>
                        </div>
                        <div class="account-setting-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                            </svg>
                        </div>
                    </div>
                    <div class="account-setting-item" onclick="openChangePassword()">
                        <div class="account-setting-info">
                            <div class="account-setting-icon" style="background: #f59e0b;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                                </svg>
                            </div>
                            <div class="account-setting-text">
                                <h4>Change Password</h4>
                                <p>Update your password</p>
                            </div>
                        </div>
                        <div class="account-setting-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                            </svg>
                        </div>
                    </div>
                    <div class="account-setting-item" onclick="toggleTwoFactorAuth()">
                        <div class="account-setting-info">
                            <div class="account-setting-icon" style="background: #8b5cf6;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/>
                                </svg>
                            </div>
                            <div class="account-setting-text">
                                <h4>Two-Factor Authentication</h4>
                                <p id="two-factor-status">Add extra security to your account</p>
                            </div>
                        </div>
                        <div class="account-setting-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="two-factor-toggle" onclick="event.stopPropagation()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="account-actions">
                    <a href="https://apps.apple.com/app/tripportier" class="account-btn account-btn-secondary">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                        </svg>
                        Open in App for Full Features
                    </a>
                    <button class="account-btn account-btn-danger" onclick="signOutUser()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div class="edit-modal" id="edit-profile-modal">
            <div class="edit-modal-backdrop" onclick="closeEditProfile()"></div>
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3>Edit Profile</h3>
                    <button class="edit-modal-close" onclick="closeEditProfile()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <div class="edit-error" id="edit-profile-error"></div>
                    <div class="edit-avatar-section">
                        <div class="edit-avatar-preview" id="edit-avatar-preview"></div>
                        <input type="file" id="avatar-file-input" accept="image/*" style="display: none;" onchange="handleAvatarSelect(event)">
                        <button class="edit-avatar-btn" onclick="document.getElementById('avatar-file-input').click()">Change Photo</button>
                    </div>
                    <div class="edit-form-group">
                        <label>Display Name</label>
                        <input type="text" id="edit-display-name" placeholder="Your name">
                    </div>
                    <div class="edit-form-group">
                        <label>Username</label>
                        <div style="display: flex; align-items: center; gap: 0; border: 2px solid var(--theme-border, #e2e8f0); border-radius: 10px; overflow: hidden;">
                            <span style="padding: 0.875rem; background: var(--theme-bg-secondary); color: var(--theme-text-secondary);">@</span>
                            <input type="text" id="edit-username" placeholder="yourname" style="border: none; flex: 1; padding: 0.875rem; padding-left: 0;">
                            <span id="edit-username-status" style="padding-right: 0.875rem;"></span>
                        </div>
                        <p style="color: var(--theme-text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                            Lowercase letters, numbers, and underscores only. Minimum 3 characters.
                        </p>
                        <p id="edit-username-error" style="color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; display: none;"></p>
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button class="edit-cancel-btn" onclick="closeEditProfile()">Cancel</button>
                    <button class="edit-save-btn" id="save-profile-btn" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Change Email Modal -->
        <div class="edit-modal" id="change-email-modal">
            <div class="edit-modal-backdrop" onclick="closeChangeEmail()"></div>
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3>Change Email</h3>
                    <button class="edit-modal-close" onclick="closeChangeEmail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <div class="edit-error" id="change-email-error"></div>
                    <p style="color: var(--theme-text-secondary); font-size: 0.9375rem; margin-bottom: 1.5rem;">
                        Enter your new email address. You'll need to verify your current password.
                    </p>
                    <div class="edit-form-group">
                        <label>New Email</label>
                        <input type="email" id="new-email-input" placeholder="new@email.com">
                    </div>
                    <div class="edit-form-group">
                        <label>Current Password</label>
                        <input type="password" id="email-password-input" placeholder="Enter your password">
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button class="edit-cancel-btn" onclick="closeChangeEmail()">Cancel</button>
                    <button class="edit-save-btn" id="change-email-btn" onclick="changeEmail()">Update Email</button>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div class="edit-modal" id="change-password-modal">
            <div class="edit-modal-backdrop" onclick="closeChangePassword()"></div>
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3>Change Password</h3>
                    <button class="edit-modal-close" onclick="closeChangePassword()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <div class="edit-error" id="change-password-error"></div>
                    <div class="edit-form-group">
                        <label>Current Password</label>
                        <input type="password" id="current-password-input" placeholder="Enter current password">
                    </div>
                    <div class="edit-form-group">
                        <label>New Password</label>
                        <input type="password" id="new-password-input" placeholder="Enter new password">
                    </div>
                    <div class="edit-form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirm-password-input" placeholder="Confirm new password">
                    </div>
                </div>
                <div class="edit-modal-footer">
                    <button class="edit-cancel-btn" onclick="closeChangePassword()">Cancel</button>
                    <button class="edit-save-btn" id="change-password-btn" onclick="changePassword()">Update Password</button>
                </div>
            </div>
        </div>

        <!-- Profile Setup Modal (for new users) -->
        <div class="edit-modal" id="profile-setup-modal">
            <div class="edit-modal-backdrop"></div>
            <div class="edit-modal-content" style="max-width: 500px;">
                <div class="edit-modal-header">
                    <h3>Complete Your Profile</h3>
                </div>
                <div class="edit-modal-body">
                    <p style="color: var(--theme-text-secondary); font-size: 0.9375rem; margin-bottom: 1.5rem; text-align: center;">
                        Set up your profile to connect with other travelers and access all features.
                    </p>
                    <div class="edit-error" id="profile-setup-error"></div>

                    <!-- Step indicators -->
                    <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 1.5rem;">
                        <div class="setup-step-dot active" id="step-dot-1"></div>
                        <div class="setup-step-dot" id="step-dot-2"></div>
                        <div class="setup-step-dot" id="step-dot-3"></div>
                    </div>

                    <!-- Step 1: Name -->
                    <div id="setup-step-1" class="setup-step">
                        <h4 style="font-size: 1.125rem; margin-bottom: 1rem; text-align: center;">What's your name?</h4>
                        <div class="edit-form-group">
                            <label>Display Name</label>
                            <input type="text" id="setup-display-name" placeholder="Your name">
                            <p style="color: var(--theme-text-muted); font-size: 0.75rem; margin-top: 0.5rem;">This is how other travelers will see you</p>
                        </div>
                    </div>

                    <!-- Step 2: Username -->
                    <div id="setup-step-2" class="setup-step" style="display: none;">
                        <h4 style="font-size: 1.125rem; margin-bottom: 1rem; text-align: center;">Choose a username</h4>
                        <div class="edit-form-group">
                            <label>Username</label>
                            <div style="display: flex; align-items: center; gap: 0; border: 2px solid var(--theme-border, #e2e8f0); border-radius: 10px; overflow: hidden;">
                                <span style="padding: 0.875rem; background: var(--theme-bg-secondary); color: var(--theme-text-secondary);">@</span>
                                <input type="text" id="setup-username" placeholder="yourname" style="border: none; flex: 1; padding: 0.875rem; padding-left: 0;">
                                <span id="username-status" style="padding-right: 0.875rem;"></span>
                            </div>
                            <p style="color: var(--theme-text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                                Lowercase letters, numbers, and underscores only. Minimum 3 characters.
                            </p>
                            <p id="username-error" style="color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; display: none;"></p>
                        </div>
                    </div>

                    <!-- Step 3: Birthday -->
                    <div id="setup-step-3" class="setup-step" style="display: none;">
                        <h4 style="font-size: 1.125rem; margin-bottom: 1rem; text-align: center;">When's your birthday?</h4>
                        <div class="edit-form-group">
                            <label>Birthday</label>
                            <input type="date" id="setup-birthday" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--theme-border, #e2e8f0); border-radius: 10px; font-size: 1rem; color: var(--theme-text, #1e293b); background: var(--theme-bg, white);">
                            <p style="color: var(--theme-text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                                Used for age-appropriate content. You must be at least 13 years old.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="edit-modal-footer" style="flex-direction: column; gap: 0.5rem;">
                    <button class="edit-save-btn" id="setup-next-btn" onclick="nextSetupStep()" style="width: 100%;">Continue</button>
                    <button class="edit-cancel-btn" id="setup-back-btn" onclick="prevSetupStep()" style="width: 100%; display: none;">Back</button>
                </div>
            </div>
        </div>

        <!-- Cashback Card (shown when logged in) -->
        <div class="cashback-card" id="cashback-card" style="display: none;">
            <div class="cashback-header">
                <div>
                    <div class="cashback-label">Your Cashback Balance</div>
                    <div class="cashback-balance" id="cashback-balance">$0.00</div>
                </div>
                <div class="cashback-level" id="cashback-level">Explorer</div>
            </div>
            <div class="cashback-info">
                <div class="cashback-row">
                    <span class="cashback-row-label">Current Level Cashback</span>
                    <span class="cashback-row-value" id="cashback-percentage">3%</span>
                </div>
                <div class="cashback-row">
                    <span class="cashback-row-label">Total eSIM Spend</span>
                    <span class="cashback-row-value" id="total-spend">$0.00</span>
                </div>
                <div class="cashback-progress" id="level-progress-section">
                    <div class="cashback-progress-label">
                        <span id="progress-label">Spend $25 more to reach Adventurer (5%)</span>
                    </div>
                    <div class="cashback-progress-bar">
                        <div class="cashback-progress-fill" id="progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="cashback-referral">
                <div>
                    <div class="cashback-row-label">Your Referral Code</div>
                    <div class="cashback-referral-code" id="referral-code">--------</div>
                </div>
                <button class="cashback-copy-btn" onclick="copyReferralCode()">Copy</button>
            </div>
        </div>

        <!-- App Promo -->
        <div class="app-promo">
            <h3>Get the Full Experience</h3>
            <p>Download the TripPortier app to access all features including AI itinerary planning, flight tracking, and more.</p>
            <a href="https://apps.apple.com/app/tripportier" class="app-promo-btn">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                </svg>
                Download on App Store
            </a>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <footer class="footer">
        <!-- Trust Bar -->
        <div class="footer-trust-bar">
            <div class="trust-bar-container">
                <div class="trust-item">
                    <span class="trust-icon">&#128274;</span>
                    <span>Secure Payments</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#9989;</span>
                    <span>Verified Provider</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#128176;</span>
                    <span>Money-Back Guarantee</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#127760;</span>
                    <span>200+ Countries</span>
                </div>
            </div>
        </div>
        <div class="footer-container">
            <div class="footer-section">
                <h4>TripPortier</h4>
                <p style="color: #94a3b8; margin-bottom: 1rem;">Your smart travel companion for stress-free trips.</p>
                <!-- Language & Currency Selectors -->
                <div class="footer-selectors">
                    <div class="selector-group">
                        <label for="currency-select">&#128176; Currency</label>
                        <select id="currency-select" class="footer-select" onchange="changeCurrency(this.value)">
                            <option value="USD">$ USD</option>
                            <option value="EUR">€ EUR</option>
                            <option value="GBP">£ GBP</option>
                            <option value="CHF">CHF</option>
                            <option value="JPY">¥ JPY</option>
                            <option value="CNY">¥ CNY</option>
                            <option value="KRW">₩ KRW</option>
                            <option value="AUD">$ AUD</option>
                            <option value="CAD">$ CAD</option>
                            <option value="NZD">$ NZD</option>
                            <option value="SGD">$ SGD</option>
                            <option value="HKD">$ HKD</option>
                            <option value="SEK">kr SEK</option>
                            <option value="NOK">kr NOK</option>
                            <option value="DKK">kr DKK</option>
                            <option value="PLN">zł PLN</option>
                            <option value="CZK">Kč CZK</option>
                            <option value="THB">฿ THB</option>
                            <option value="MYR">RM MYR</option>
                            <option value="INR">₹ INR</option>
                            <option value="BRL">R$ BRL</option>
                            <option value="MXN">$ MXN</option>
                            <option value="AED">د.إ AED</option>
                            <option value="SAR">﷼ SAR</option>
                            <option value="TRY">₺ TRY</option>
                            <option value="ZAR">R ZAR</option>
                            <option value="ILS">₪ ILS</option>
                            <option value="TWD">$ TWD</option>
                            <option value="PHP">₱ PHP</option>
                            <option value="IDR">Rp IDR</option>
                            <option value="VND">₫ VND</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="footer-section">
                <h4>Services</h4>
                <ul>
                    <li><a href="esim.html">eSIM</a></li>
                    <li><a href="airport-transfers.html">Airport Transfers</a></li>
                    <li><a href="https://asiatransport.tripportier.com" target="_blank">Asia Transport</a></li>
                    <li><a href="https://apps.apple.com/app/tripportier">Download App</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <ul>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="feature-request.html">Request Feature</a></li>
                    <li><a href="https://wa.me/41765125678">Contact Us</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms of Service</a></li>
                    <li><a href="attributions.html">Attributions</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <span>We accept:</span>
                <svg height="24" viewBox="0 0 750 471" aria-label="Visa"><path fill="#1434CB" d="M278 334l33-195h51l-32 195zm137-190c-10-4-26-8-46-8-51 0-87 26-87 63 0 28 26 43 45 52 20 9 27 15 27 24 0 13-16 19-31 19-21 0-32-3-49-10l-7-3-7 43c12 5 35 10 58 10 54 0 89-25 89-65 0-22-14-38-44-52-18-9-30-15-30-24 0-8 10-17 30-17 17 0 30 3 40 7l5 2 7-41zm128-5h-40c-12 0-22 4-27 17l-77 177h54l11-29h66l6 29h48l-41-194zm-62 126l21-55 6-16 3 14 12 57h-42zM193 139l-50 133-5-26c-10-31-40-65-74-82l46 170h55l82-195h-54z"/><path fill="#F9A533" d="M131 139H50l-1 5c65 16 108 54 126 100l-18-88c-3-12-12-16-26-17z"/></svg>
                <svg height="24" viewBox="0 0 750 471" aria-label="Mastercard"><circle fill="#EB001B" cx="250" cy="235" r="150"/><circle fill="#F79E1B" cx="500" cy="235" r="150"/><path fill="#FF5F00" d="M325 113c42 33 69 84 69 141s-27 108-69 141c-42-33-69-84-69-141s27-108 69-141z"/></svg>
                <svg height="24" viewBox="0 0 750 471" aria-label="American Express"><rect fill="#2E77BC" width="750" height="471" rx="40"/><path fill="#fff" d="M0 220h83l19-43 19 43h166v-33l15 33h85l15-34v34h250v-70h-27c-7 0-9 1-9 9v14h-73v-23h71c11 0 22 0 31 6v-70H395l-17 38-18-38H193v33l-17-33H96L0 220zm113-99l-73 165h46l14-31h78l13 31h47l-73-165h-52zm26 47l24 55h-48l24-55zm118-47v165h42v-116l48 116h36l48-116v116h42v-165h-66l-41 98-44-98h-65zm347 0v165h129v-34H646v-29h58v-34h-58v-33h62v-35H604zm-228 99c0 39 29 69 74 69 21 0 39-4 52-13v-41h-62v32h21v14c-4 2-10 3-17 3-24 0-38-17-38-42 0-25 15-42 41-42 14 0 25 4 35 12l24-28c-16-13-37-19-61-19-46 0-69 30-69 55z"/></svg>
                <svg height="24" viewBox="0 0 750 471" aria-label="PayPal"><path fill="#003087" d="M248 89h-69c-5 0-9 3-10 8l-28 177c-1 4 2 7 6 7h36c3 0 6-2 7-6l8-50c1-5 5-8 10-8h23c47 0 74-22 81-67 3-20 0-35-10-46-11-12-30-15-54-15zm8 66c-4 25-24 25-43 25h-11l8-49c0-3 3-5 6-5h5c13 0 26 0 32 8 4 4 5 11 3 21z"/><path fill="#009cde" d="M400 154h-36c-3 0-5 2-6 5l-2 10-2-4c-8-11-24-15-41-15-38 0-71 29-77 69-3 20 1 40 13 53 10 12 25 17 43 17 30 0 47-19 47-19l-2 10c-1 4 2 7 6 7h32c5 0 9-3 10-8l19-118c1-4-2-7-4-7zm-47 67c-4 19-18 32-37 32-10 0-17-3-22-9-5-6-7-14-5-23 3-19 18-32 36-32 9 0 17 3 22 9 5 6 7 14 6 23z"/><path fill="#003087" d="M560 154h-36c-3 0-6 2-7 4l-41 60-17-58c-1-4-5-6-9-6h-35c-4 0-7 4-6 8l33 96-31 43c-3 4 0 9 5 9h36c3 0 6-1 7-4l99-143c3-4 0-9-5-9z"/><path fill="#009cde" d="M641 89h-69c-5 0-9 3-10 8l-28 177c-1 4 2 7 6 7h38c3 0 6-2 7-6l8-52c1-5 5-8 10-8h23c47 0 74-22 81-67 3-20 0-35-10-46-11-12-30-13-56-13zm8 66c-4 25-23 25-42 25h-11l8-49c0-3 3-5 6-5h5c13 0 25 0 31 8 4 4 6 11 3 21z"/></svg>
            </div>
            <p>&copy; 2025 TripPortier. All rights reserved.</p>
        </div>
    </footer>

    <!-- Footer JavaScript Functions -->
    <script>
        function changeCurrency(currency) {
            console.log('Currency changed to:', currency);
            // TODO: Implement currency switching logic
            // For now, just save preference
            localStorage.setItem('preferredCurrency', currency);
        }

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedCurrency = localStorage.getItem('preferredCurrency');

            if (savedCurrency) {
                const currencySelect = document.getElementById('currency-select');
                if (currencySelect) currencySelect.value = savedCurrency;
            }
        });
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <!-- TripPortier Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/auth-ui.js"></script>
    <script src="js/subscription.js"></script>
    <script src="js/main.js"></script>

    <script>
        // Reward level configuration (matching iOS app)
        const REWARD_LEVELS = {
            explorer: { name: 'Explorer', percentage: '3%', minSpend: 0 },
            adventurer: { name: 'Adventurer', percentage: '5%', minSpend: 25 },
            globetrotter: { name: 'Globetrotter', percentage: '6%', minSpend: 75 },
            pioneer: { name: 'Pioneer', percentage: '7%', minSpend: 100 },
            ambassador: { name: 'Ambassador', percentage: '10%', minSpend: 150 }
        };

        const LEVEL_ORDER = ['explorer', 'adventurer', 'globetrotter', 'pioneer', 'ambassador'];

        function getNextLevel(currentLevel) {
            const idx = LEVEL_ORDER.indexOf(currentLevel.toLowerCase());
            if (idx >= 0 && idx < LEVEL_ORDER.length - 1) {
                return REWARD_LEVELS[LEVEL_ORDER[idx + 1]];
            }
            return null;
        }

        // Account page logic
        function updateAccountUI(user, profile) {
            const loadingEl = document.getElementById('account-loading');
            const guestEl = document.getElementById('account-guest');
            const contentEl = document.getElementById('account-content');
            const cashbackCard = document.getElementById('cashback-card');

            loadingEl.style.display = 'none';

            if (user) {
                guestEl.style.display = 'none';
                contentEl.style.display = 'block';

                // Update avatar
                const avatarContainer = document.getElementById('account-avatar-container');
                const avatarURL = profile?.profileImageURL || user.photoURL;
                const displayName = profile?.displayName || user.displayName || user.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();

                if (avatarURL) {
                    avatarContainer.innerHTML = `<img src="${avatarURL}" alt="${displayName}" class="account-avatar">`;
                } else {
                    avatarContainer.innerHTML = `<div class="account-avatar-placeholder">${initial}</div>`;
                }

                // Update name, username, and email
                document.getElementById('account-name').textContent = displayName;
                const username = profile?.username;
                const usernameEl = document.getElementById('account-username');
                if (username) {
                    usernameEl.textContent = '@' + username;
                    usernameEl.style.display = 'block';
                } else {
                    usernameEl.style.display = 'none';
                }
                document.getElementById('account-email').textContent = user.email;

                // Check if profile is incomplete (no username) and show setup modal
                if (!username && profile) {
                    setTimeout(() => showProfileSetup(), 500);
                }

                // Update member since
                if (profile?.memberSince) {
                    const memberDate = profile.memberSince.toDate();
                    document.getElementById('account-member-since').textContent = memberDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else if (user.metadata?.creationTime) {
                    const creationDate = new Date(user.metadata.creationTime);
                    document.getElementById('account-member-since').textContent = creationDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                // Update UID (shortened)
                const uid = user.uid;
                document.getElementById('account-uid').textContent = uid.substring(0, 8) + '...';

                // Fetch and display cashback data
                fetchCashbackData(user.uid);

                // Fetch and display subscription status
                fetchSubscriptionData(user.uid);

                // Update 2FA toggle
                updateTwoFactorToggle(profile?.twoFactorEnabled || false);

                // Load referral code, preferences, and friends
                loadReferralCode(user.uid);
                loadUserPreferences(user.uid, profile);
                loadFriends(user.uid);
                populateCountryDropdown();
            } else {
                guestEl.style.display = 'block';
                contentEl.style.display = 'none';
                cashbackCard.style.display = 'none';
            }
        }

        async function fetchCashbackData(userId) {
            const cashbackCard = document.getElementById('cashback-card');

            try {
                const doc = await window.firebaseDb.collection('esimRewards').doc(userId).get();

                if (doc.exists) {
                    const data = doc.data();
                    updateCashbackUI(data);
                    cashbackCard.style.display = 'block';
                } else {
                    // No rewards data yet - show card with default values
                    updateCashbackUI({
                        totalCredits: 0,
                        totalSpend: 0,
                        level: 'Explorer',
                        referralCode: '--------'
                    });
                    cashbackCard.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching cashback data:', error);
                // Show card with default values on error
                cashbackCard.style.display = 'block';
            }
        }

        function updateCashbackUI(data) {
            const balance = data.totalCredits || 0;
            const spend = data.totalSpend || 0;
            const level = (data.level || 'Explorer').toLowerCase();
            const levelConfig = REWARD_LEVELS[level] || REWARD_LEVELS.explorer;
            const referralCode = data.referralCode || '--------';

            // Update balance
            document.getElementById('cashback-balance').textContent = `$${balance.toFixed(2)}`;

            // Update level
            document.getElementById('cashback-level').textContent = levelConfig.name;
            document.getElementById('cashback-percentage').textContent = levelConfig.percentage;

            // Update total spend
            document.getElementById('total-spend').textContent = `$${spend.toFixed(2)}`;

            // Update referral code
            document.getElementById('referral-code').textContent = referralCode;

            // Update progress to next level
            const nextLevel = getNextLevel(level);
            const progressSection = document.getElementById('level-progress-section');

            if (nextLevel) {
                const currentMin = levelConfig.minSpend;
                const nextMin = nextLevel.minSpend;
                const range = nextMin - currentMin;
                const progress = Math.max(0, spend - currentMin);
                const percentage = Math.min(100, (progress / range) * 100);
                const remaining = Math.max(0, nextMin - spend);

                document.getElementById('progress-label').textContent =
                    `Spend $${remaining.toFixed(0)} more to reach ${nextLevel.name} (${nextLevel.percentage})`;
                document.getElementById('progress-fill').style.width = `${percentage}%`;
                progressSection.style.display = 'block';
            } else {
                // Max level reached
                document.getElementById('progress-label').textContent = 'You\'ve reached the highest level!';
                document.getElementById('progress-fill').style.width = '100%';
            }
        }

        async function fetchSubscriptionData(userId) {
            try {
                if (!window.subscriptionManager) {
                    console.warn('Subscription manager not loaded');
                    return;
                }

                const { isSubscribed, subscription } = await window.subscriptionManager.getSubscriptionStatus(userId);
                updateSubscriptionUI(isSubscribed, subscription);
            } catch (error) {
                console.error('Error fetching subscription data:', error);
                // Show free plan on error
                updateSubscriptionUI(false, null);
            }
        }

        function updateSubscriptionUI(isSubscribed, subscription) {
            const statusEl = document.getElementById('subscription-status');
            const iconEl = document.getElementById('subscription-icon');
            const textEl = document.getElementById('subscription-text');
            const planNameEl = document.getElementById('subscription-plan-name');
            const detailsEl = document.getElementById('subscription-details');
            const actionEl = document.getElementById('subscription-action');

            if (isSubscribed && subscription) {
                // Premium state
                statusEl.classList.add('active');
                iconEl.classList.remove('free');
                iconEl.classList.add('premium');
                textEl.classList.add('active');

                // Update icon to crown/star
                iconEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                `;

                // Update plan name
                const planName = window.subscriptionManager.getPlanName(subscription.planId);
                planNameEl.textContent = planName;

                // Update details with expiration
                const expirationStr = window.subscriptionManager.formatExpirationDate(subscription.expirationDate);
                const platformStr = window.subscriptionManager.getPlatformName(subscription.platform);

                if (subscription.status === 'cancelled') {
                    detailsEl.textContent = `Expires ${expirationStr} (cancelled)`;
                } else {
                    detailsEl.textContent = `Renews ${expirationStr} • via ${platformStr}`;
                }

                // Update action button
                actionEl.textContent = 'Manage';
                actionEl.href = 'premium.html';
            } else {
                // Free state
                statusEl.classList.remove('active');
                iconEl.classList.remove('premium');
                iconEl.classList.add('free');
                textEl.classList.remove('active');

                // Reset icon to lock
                iconEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                `;

                planNameEl.textContent = 'Free Plan';
                detailsEl.textContent = 'Upgrade to unlock all features';
                actionEl.textContent = 'Upgrade';
                actionEl.href = 'premium.html';
            }
        }

        function copyReferralCode() {
            const code = document.getElementById('referral-code').textContent;
            if (code && code !== '--------') {
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.querySelector('.cashback-copy-btn');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }

        async function signOutUser() {
            if (confirm('Are you sure you want to sign out?')) {
                await window.tripPortierAuth.signOut();
                window.location.href = 'index.html';
            }
        }

        // Listen to auth state
        document.addEventListener('DOMContentLoaded', function() {
            if (window.tripPortierAuth) {
                window.tripPortierAuth.addListener(updateAccountUI);
            }
        });

        // ============================================
        // Edit Profile Functions
        // ============================================
        let selectedAvatarFile = null;
        let currentUsername = '';
        let editUsernameCheckTimeout = null;
        let isEditUsernameAvailable = true;
        let isEditCheckingUsername = false;

        function openEditProfile() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const modal = document.getElementById('edit-profile-modal');
            const previewEl = document.getElementById('edit-avatar-preview');
            const nameInput = document.getElementById('edit-display-name');
            const usernameInput = document.getElementById('edit-username');
            const errorEl = document.getElementById('edit-profile-error');

            // Reset error
            errorEl.classList.remove('show');
            errorEl.textContent = '';
            selectedAvatarFile = null;
            document.getElementById('edit-username-status').innerHTML = '';
            document.getElementById('edit-username-error').style.display = 'none';

            // Get current profile data
            window.firebaseDb.collection('users').doc(user.uid).get().then(doc => {
                const profile = doc.exists ? doc.data() : {};
                const avatarURL = profile.profileImageURL || user.photoURL;
                const displayName = profile.displayName || user.displayName || '';
                currentUsername = profile.username || '';

                // Set avatar preview
                if (avatarURL) {
                    previewEl.innerHTML = `<img src="${avatarURL}" alt="Avatar">`;
                } else {
                    const initial = displayName.charAt(0).toUpperCase() || user.email.charAt(0).toUpperCase();
                    previewEl.innerHTML = `<div class="account-avatar-placeholder" style="margin: 0;">${initial}</div>`;
                }

                // Set name and username
                nameInput.value = displayName;
                usernameInput.value = currentUsername;
                isEditUsernameAvailable = true; // Current username is always available for the user

                // Add username input listener
                usernameInput.oninput = function() {
                    let value = this.value.toLowerCase()
                        .replace(/\s/g, '')
                        .replace(/[^a-z0-9_]/g, '');
                    this.value = value;

                    clearTimeout(editUsernameCheckTimeout);
                    if (value.length >= 3 && value !== currentUsername) {
                        editUsernameCheckTimeout = setTimeout(() => checkEditUsernameAvailability(value), 500);
                    } else if (value === currentUsername) {
                        document.getElementById('edit-username-status').innerHTML = '';
                        document.getElementById('edit-username-error').style.display = 'none';
                        isEditUsernameAvailable = true;
                    } else {
                        document.getElementById('edit-username-status').innerHTML = '';
                        document.getElementById('edit-username-error').style.display = 'none';
                        isEditUsernameAvailable = false;
                    }
                };

                // Show modal
                modal.classList.add('active');
            }).catch(err => {
                console.error('Error loading profile:', err);
                // Still show modal with auth data
                const displayName = user.displayName || '';
                nameInput.value = displayName;
                usernameInput.value = '';
                currentUsername = '';
                if (user.photoURL) {
                    previewEl.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
                } else {
                    const initial = displayName.charAt(0).toUpperCase() || user.email.charAt(0).toUpperCase();
                    previewEl.innerHTML = `<div class="account-avatar-placeholder" style="margin: 0;">${initial}</div>`;
                }
                modal.classList.add('active');
            });
        }

        async function checkEditUsernameAvailability(username) {
            if (username.length < 3 || username === currentUsername) {
                isEditUsernameAvailable = username === currentUsername;
                return;
            }

            isEditCheckingUsername = true;
            const statusEl = document.getElementById('edit-username-status');
            const errorEl = document.getElementById('edit-username-error');

            statusEl.innerHTML = '<div class="auth-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>';
            errorEl.style.display = 'none';

            try {
                const snapshot = await window.firebaseDb.collection('users')
                    .where('username', '==', username)
                    .limit(1)
                    .get();

                isEditUsernameAvailable = snapshot.empty;

                if (isEditUsernameAvailable) {
                    statusEl.innerHTML = '<span style="color: #22c55e; font-size: 18px;">&#10003;</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #dc2626; font-size: 18px;">&#10007;</span>';
                    errorEl.textContent = 'This username is already taken';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking username:', error);
                statusEl.innerHTML = '';
                isEditUsernameAvailable = false;
            }

            isEditCheckingUsername = false;
        }

        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('active');
            selectedAvatarFile = null;
        }

        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showProfileError('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showProfileError('Image must be less than 5MB');
                return;
            }

            selectedAvatarFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewEl = document.getElementById('edit-avatar-preview');
                previewEl.innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
            };
            reader.readAsDataURL(file);
        }

        function showProfileError(message) {
            const errorEl = document.getElementById('edit-profile-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        async function saveProfile() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const nameInput = document.getElementById('edit-display-name');
            const usernameInput = document.getElementById('edit-username');
            const saveBtn = document.getElementById('save-profile-btn');
            const errorEl = document.getElementById('edit-profile-error');

            const displayName = nameInput.value.trim();
            const username = usernameInput.value.trim().toLowerCase();

            if (!displayName) {
                showProfileError('Please enter a display name');
                return;
            }

            // Validate username if changed
            if (username !== currentUsername) {
                if (!username) {
                    showProfileError('Please enter a username');
                    return;
                }
                if (username.length < 3) {
                    showProfileError('Username must be at least 3 characters');
                    return;
                }
                if (isEditCheckingUsername) {
                    showProfileError('Please wait while we check username availability');
                    return;
                }
                if (!isEditUsernameAvailable) {
                    showProfileError('Please choose an available username');
                    return;
                }
            }

            // Disable button and show loading
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            errorEl.classList.remove('show');

            try {
                let photoURL = user.photoURL;

                // Upload new avatar if selected
                if (selectedAvatarFile) {
                    const storage = firebase.storage();
                    const storageRef = storage.ref();
                    const avatarRef = storageRef.child(`profile_images/${user.uid}.jpg`);

                    // Upload file
                    await avatarRef.put(selectedAvatarFile);

                    // Get download URL
                    photoURL = await avatarRef.getDownloadURL();
                }

                // Update Firebase Auth profile
                await user.updateProfile({
                    displayName: displayName,
                    photoURL: photoURL
                });

                // Update Firestore profile
                await window.firebaseDb.collection('users').doc(user.uid).set({
                    displayName: displayName,
                    username: username,
                    profileImageURL: photoURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Refresh UI
                const doc = await window.firebaseDb.collection('users').doc(user.uid).get();
                updateAccountUI(user, doc.exists ? doc.data() : null);

                // Close modal
                closeEditProfile();

            } catch (error) {
                console.error('Error saving profile:', error);
                showProfileError(error.message || 'Failed to save profile');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // ============================================
        // Change Email Functions
        // ============================================
        function openChangeEmail() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const modal = document.getElementById('change-email-modal');
            const errorEl = document.getElementById('change-email-error');
            const emailInput = document.getElementById('new-email-input');
            const passwordInput = document.getElementById('email-password-input');

            // Reset
            errorEl.classList.remove('show');
            errorEl.textContent = '';
            emailInput.value = '';
            passwordInput.value = '';

            modal.classList.add('active');
        }

        function closeChangeEmail() {
            document.getElementById('change-email-modal').classList.remove('active');
        }

        function showEmailError(message) {
            const errorEl = document.getElementById('change-email-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        async function changeEmail() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const emailInput = document.getElementById('new-email-input');
            const passwordInput = document.getElementById('email-password-input');
            const changeBtn = document.getElementById('change-email-btn');
            const errorEl = document.getElementById('change-email-error');

            const newEmail = emailInput.value.trim();
            const password = passwordInput.value;

            // Validate
            if (!newEmail) {
                showEmailError('Please enter a new email address');
                return;
            }

            if (!password) {
                showEmailError('Please enter your current password');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showEmailError('Please enter a valid email address');
                return;
            }

            // Disable button and show loading
            changeBtn.disabled = true;
            changeBtn.textContent = 'Updating...';
            errorEl.classList.remove('show');

            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);

                // Update email
                await user.updateEmail(newEmail);

                // Update Firestore
                await window.firebaseDb.collection('users').doc(user.uid).set({
                    email: newEmail,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Refresh UI
                document.getElementById('account-email').textContent = newEmail;

                // Close modal
                closeChangeEmail();
                alert('Email updated successfully!');

            } catch (error) {
                console.error('Error changing email:', error);
                let message = 'Failed to change email';
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password';
                } else if (error.code === 'auth/email-already-in-use') {
                    message = 'This email is already in use';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                } else if (error.code === 'auth/requires-recent-login') {
                    message = 'Please sign out and sign in again before changing email';
                }
                showEmailError(message);
            } finally {
                changeBtn.disabled = false;
                changeBtn.textContent = 'Update Email';
            }
        }

        // ============================================
        // Change Password Functions
        // ============================================
        function openChangePassword() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const modal = document.getElementById('change-password-modal');
            const errorEl = document.getElementById('change-password-error');
            const currentInput = document.getElementById('current-password-input');
            const newInput = document.getElementById('new-password-input');
            const confirmInput = document.getElementById('confirm-password-input');

            // Reset
            errorEl.classList.remove('show');
            errorEl.textContent = '';
            currentInput.value = '';
            newInput.value = '';
            confirmInput.value = '';

            modal.classList.add('active');
        }

        function closeChangePassword() {
            document.getElementById('change-password-modal').classList.remove('active');
        }

        function showPasswordError(message) {
            const errorEl = document.getElementById('change-password-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        async function changePassword() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const currentInput = document.getElementById('current-password-input');
            const newInput = document.getElementById('new-password-input');
            const confirmInput = document.getElementById('confirm-password-input');
            const changeBtn = document.getElementById('change-password-btn');
            const errorEl = document.getElementById('change-password-error');

            const currentPassword = currentInput.value;
            const newPassword = newInput.value;
            const confirmPassword = confirmInput.value;

            // Validate
            if (!currentPassword) {
                showPasswordError('Please enter your current password');
                return;
            }

            if (!newPassword) {
                showPasswordError('Please enter a new password');
                return;
            }

            if (newPassword.length < 6) {
                showPasswordError('New password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                showPasswordError('New passwords do not match');
                return;
            }

            // Disable button and show loading
            changeBtn.disabled = true;
            changeBtn.textContent = 'Updating...';
            errorEl.classList.remove('show');

            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                await user.reauthenticateWithCredential(credential);

                // Update password
                await user.updatePassword(newPassword);

                // Close modal
                closeChangePassword();
                alert('Password updated successfully!');

            } catch (error) {
                console.error('Error changing password:', error);
                let message = 'Failed to change password';
                if (error.code === 'auth/wrong-password') {
                    message = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    message = 'New password is too weak';
                } else if (error.code === 'auth/requires-recent-login') {
                    message = 'Please sign out and sign in again before changing password';
                }
                showPasswordError(message);
            } finally {
                changeBtn.disabled = false;
                changeBtn.textContent = 'Update Password';
            }
        }

        // ============================================
        // Profile Setup Functions (for new users)
        // ============================================
        let currentSetupStep = 1;
        let isCheckingUsername = false;
        let usernameCheckTimeout = null;
        let isUsernameAvailable = false;

        function showProfileSetup() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const modal = document.getElementById('profile-setup-modal');
            const errorEl = document.getElementById('profile-setup-error');
            const nameInput = document.getElementById('setup-display-name');
            const usernameInput = document.getElementById('setup-username');
            const birthdayInput = document.getElementById('setup-birthday');

            // Reset
            currentSetupStep = 1;
            errorEl.classList.remove('show');
            errorEl.textContent = '';

            // Pre-fill display name if available
            const profile = window.tripPortierAuth?.userProfile;
            nameInput.value = profile?.displayName || user.displayName || '';
            usernameInput.value = '';

            // Set default birthday (25 years ago)
            const defaultBirthday = new Date();
            defaultBirthday.setFullYear(defaultBirthday.getFullYear() - 25);
            birthdayInput.value = defaultBirthday.toISOString().split('T')[0];

            // Set max date (13 years ago) and min date (120 years ago)
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() - 13);
            const minDate = new Date();
            minDate.setFullYear(minDate.getFullYear() - 120);
            birthdayInput.max = maxDate.toISOString().split('T')[0];
            birthdayInput.min = minDate.toISOString().split('T')[0];

            // Reset UI to step 1
            updateSetupUI();

            // Add username input listener
            usernameInput.oninput = function() {
                // Sanitize input: lowercase, no spaces, only letters/numbers/underscore
                let value = this.value.toLowerCase()
                    .replace(/\s/g, '')
                    .replace(/[^a-z0-9_]/g, '');
                this.value = value;

                // Check availability after debounce
                clearTimeout(usernameCheckTimeout);
                if (value.length >= 3) {
                    usernameCheckTimeout = setTimeout(() => checkUsernameAvailability(value), 500);
                } else {
                    document.getElementById('username-status').innerHTML = '';
                    document.getElementById('username-error').style.display = 'none';
                    isUsernameAvailable = false;
                }
            };

            modal.classList.add('active');
        }

        function updateSetupUI() {
            // Update step dots
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`step-dot-${i}`);
                dot.classList.remove('active', 'completed');
                if (i < currentSetupStep) {
                    dot.classList.add('completed');
                } else if (i === currentSetupStep) {
                    dot.classList.add('active');
                }
            }

            // Show/hide steps
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`setup-step-${i}`).style.display = i === currentSetupStep ? 'block' : 'none';
            }

            // Update buttons
            const nextBtn = document.getElementById('setup-next-btn');
            const backBtn = document.getElementById('setup-back-btn');

            backBtn.style.display = currentSetupStep > 1 ? 'block' : 'none';
            nextBtn.textContent = currentSetupStep === 3 ? 'Complete Setup' : 'Continue';
        }

        async function checkUsernameAvailability(username) {
            if (username.length < 3) {
                isUsernameAvailable = false;
                return;
            }

            isCheckingUsername = true;
            const statusEl = document.getElementById('username-status');
            const errorEl = document.getElementById('username-error');

            statusEl.innerHTML = '<div class="auth-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>';
            errorEl.style.display = 'none';

            try {
                // Check if username exists in Firestore
                const snapshot = await window.firebaseDb.collection('users')
                    .where('username', '==', username)
                    .limit(1)
                    .get();

                isUsernameAvailable = snapshot.empty;

                if (isUsernameAvailable) {
                    statusEl.innerHTML = '<span style="color: #22c55e; font-size: 18px;">&#10003;</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #dc2626; font-size: 18px;">&#10007;</span>';
                    errorEl.textContent = 'This username is already taken';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking username:', error);
                statusEl.innerHTML = '';
                isUsernameAvailable = false;
            }

            isCheckingUsername = false;
        }

        function showSetupError(message) {
            const errorEl = document.getElementById('profile-setup-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        async function nextSetupStep() {
            const errorEl = document.getElementById('profile-setup-error');
            errorEl.classList.remove('show');

            if (currentSetupStep === 1) {
                // Validate name
                const name = document.getElementById('setup-display-name').value.trim();
                if (!name) {
                    showSetupError('Please enter your name');
                    return;
                }
                currentSetupStep = 2;
                updateSetupUI();
            } else if (currentSetupStep === 2) {
                // Validate username
                const username = document.getElementById('setup-username').value.trim();
                if (!username) {
                    showSetupError('Please enter a username');
                    return;
                }
                if (username.length < 3) {
                    showSetupError('Username must be at least 3 characters');
                    return;
                }
                if (isCheckingUsername) {
                    showSetupError('Please wait while we check username availability');
                    return;
                }
                if (!isUsernameAvailable) {
                    showSetupError('Please choose an available username');
                    return;
                }
                currentSetupStep = 3;
                updateSetupUI();
            } else if (currentSetupStep === 3) {
                // Validate birthday and save profile
                const birthdayInput = document.getElementById('setup-birthday');
                const birthday = new Date(birthdayInput.value);
                const today = new Date();
                const age = Math.floor((today - birthday) / (365.25 * 24 * 60 * 60 * 1000));

                if (isNaN(birthday.getTime())) {
                    showSetupError('Please enter your birthday');
                    return;
                }
                if (age < 13) {
                    showSetupError('You must be at least 13 years old');
                    return;
                }
                if (age > 120) {
                    showSetupError('Please enter a valid birthday');
                    return;
                }

                // Save the complete profile
                await saveProfileSetup();
            }
        }

        function prevSetupStep() {
            if (currentSetupStep > 1) {
                currentSetupStep--;
                updateSetupUI();
            }
        }

        async function saveProfileSetup() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const nextBtn = document.getElementById('setup-next-btn');
            const displayName = document.getElementById('setup-display-name').value.trim();
            const username = document.getElementById('setup-username').value.trim().toLowerCase();
            const birthdayInput = document.getElementById('setup-birthday');
            const birthday = new Date(birthdayInput.value);

            nextBtn.disabled = true;
            nextBtn.textContent = 'Saving...';

            try {
                // Update Firebase Auth profile
                await user.updateProfile({ displayName: displayName });

                // Update Firestore profile with username and birthday
                await window.firebaseDb.collection('users').doc(user.uid).set({
                    displayName: displayName,
                    username: username,
                    birthday: firebase.firestore.Timestamp.fromDate(birthday),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Close modal and refresh UI
                document.getElementById('profile-setup-modal').classList.remove('active');

                // Refresh the profile data
                await window.tripPortierAuth.fetchUserProfile(user.uid);

                // Update account page UI
                const doc = await window.firebaseDb.collection('users').doc(user.uid).get();
                updateAccountUI(user, doc.exists ? doc.data() : null);

            } catch (error) {
                console.error('Error saving profile:', error);
                showSetupError(error.message || 'Failed to save profile');
            } finally {
                nextBtn.disabled = false;
                nextBtn.textContent = 'Complete Setup';
            }
        }

        // ============================================
        // TWO-FACTOR AUTHENTICATION
        // ============================================

        let twoFactorVerificationModal = null;
        let twoFactorPendingEmail = null;

        function updateTwoFactorToggle(enabled) {
            const toggle = document.getElementById('two-factor-toggle');
            const statusText = document.getElementById('two-factor-status');

            if (toggle) {
                toggle.checked = enabled;
            }
            if (statusText) {
                statusText.textContent = enabled ? 'Enabled - Extra security active' : 'Add extra security to your account';
            }
        }

        async function toggleTwoFactorAuth() {
            const toggle = document.getElementById('two-factor-toggle');
            const user = window.tripPortierAuth.getCurrentUser();

            if (!user) {
                alert('Please sign in to manage 2FA settings');
                return;
            }

            const newState = !toggle.checked;

            if (newState) {
                // ENABLING 2FA - Show verification modal first
                await startTwoFactorSetup(user);
            } else {
                // DISABLING 2FA - Simple confirmation
                if (!confirm('Are you sure you want to disable two-factor authentication? Your account will be less secure.')) {
                    return;
                }

                toggle.disabled = true;

                try {
                    const toggleTwoFactor = firebase.functions().httpsCallable('toggleTwoFactor');
                    const result = await toggleTwoFactor({ enabled: false });

                    if (result.data.success) {
                        updateTwoFactorToggle(false);
                        alert('Two-factor authentication has been disabled.');
                    }
                } catch (error) {
                    console.error('Error disabling 2FA:', error);
                    alert('Failed to disable 2FA. Please try again.');
                } finally {
                    toggle.disabled = false;
                }
            }
        }

        async function startTwoFactorSetup(user) {
            const toggle = document.getElementById('two-factor-toggle');
            toggle.disabled = true;

            try {
                // Send verification code to user's email
                const sendTwoFactorCode = firebase.functions().httpsCallable('sendTwoFactorCode');
                await sendTwoFactorCode({ email: user.email });

                twoFactorPendingEmail = user.email;

                // Show verification modal
                showTwoFactorSetupModal(user.email);

            } catch (error) {
                console.error('Error sending 2FA code:', error);
                alert('Failed to send verification code. Please try again.');
                toggle.disabled = false;
            }
        }

        function showTwoFactorSetupModal(email) {
            // Remove existing modal if present
            if (twoFactorVerificationModal) {
                twoFactorVerificationModal.remove();
            }

            const maskedEmail = maskEmail(email);

            const modalHTML = `
            <div id="two-factor-setup-modal" class="auth-modal">
                <div class="auth-modal-overlay" onclick="closeTwoFactorSetupModal()"></div>
                <div class="auth-modal-content">
                    <button class="auth-modal-close" onclick="closeTwoFactorSetupModal()" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>

                    <div class="auth-header">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/>
                            </svg>
                        </div>
                        <h2>Verify Your Email</h2>
                        <p>We sent a 6-digit code to<br><strong>${maskedEmail}</strong></p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Enter the code to enable two-factor authentication</p>
                    </div>

                    <form id="two-factor-setup-form" onsubmit="verifyTwoFactorSetup(event)">
                        <div class="auth-field">
                            <label for="setup-otp-code">Verification Code</label>
                            <input
                                type="text"
                                id="setup-otp-code"
                                placeholder="000000"
                                maxlength="6"
                                pattern="[0-9]{6}"
                                inputmode="numeric"
                                autocomplete="one-time-code"
                                style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem; font-weight: 600;"
                                required
                            >
                        </div>

                        <div id="setup-error" class="auth-error" style="display: none;"></div>

                        <button type="submit" class="auth-btn auth-btn-primary" id="verify-setup-btn">
                            Verify & Enable 2FA
                        </button>
                    </form>

                    <div class="auth-footer" style="margin-top: 1.5rem;">
                        <p>Didn't receive the code? <a onclick="resendSetupCode()" id="resend-setup-link" style="cursor: pointer;">Resend</a></p>
                    </div>
                </div>
            </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            twoFactorVerificationModal = document.getElementById('two-factor-setup-modal');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Auto-focus the input
            setTimeout(() => {
                document.getElementById('setup-otp-code')?.focus();
            }, 100);

            // Show modal with animation
            requestAnimationFrame(() => {
                twoFactorVerificationModal.classList.add('show');
            });
        }

        function maskEmail(email) {
            const [localPart, domain] = email.split('@');
            if (localPart.length <= 2) {
                return `${localPart[0]}***@${domain}`;
            }
            return `${localPart.slice(0, 2)}***${localPart.slice(-1)}@${domain}`;
        }

        async function verifyTwoFactorSetup(e) {
            e.preventDefault();

            const code = document.getElementById('setup-otp-code').value;
            const errorEl = document.getElementById('setup-error');
            const submitBtn = document.getElementById('verify-setup-btn');

            if (!code || code.length !== 6) {
                errorEl.textContent = 'Please enter the 6-digit code';
                errorEl.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Verifying...';
            errorEl.style.display = 'none';

            try {
                // Verify the code first
                const verifyTwoFactorCode = firebase.functions().httpsCallable('verifyTwoFactorCode');
                const verifyResult = await verifyTwoFactorCode({
                    email: twoFactorPendingEmail,
                    code: code
                });

                if (verifyResult.data.success) {
                    // Code verified! Now enable 2FA
                    const toggleTwoFactor = firebase.functions().httpsCallable('toggleTwoFactor');
                    const result = await toggleTwoFactor({ enabled: true });

                    if (result.data.success) {
                        updateTwoFactorToggle(true);
                        closeTwoFactorSetupModal();
                        alert('Two-factor authentication has been enabled! You will receive a verification code via email when signing in.');
                    }
                }
            } catch (error) {
                console.error('2FA setup verification error:', error);

                let errorMessage = 'Invalid verification code. Please try again.';
                if (error.code === 'functions/deadline-exceeded') {
                    errorMessage = 'Code expired. Please request a new one.';
                } else if (error.code === 'functions/resource-exhausted') {
                    errorMessage = 'Too many attempts. Please request a new code.';
                } else if (error.code === 'functions/not-found') {
                    errorMessage = 'No code found. Please request a new one.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                errorEl.textContent = errorMessage;
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Verify & Enable 2FA';
            }
        }

        async function resendSetupCode() {
            const resendLink = document.getElementById('resend-setup-link');
            const errorEl = document.getElementById('setup-error');

            if (!twoFactorPendingEmail) return;

            try {
                resendLink.textContent = 'Sending...';
                resendLink.style.pointerEvents = 'none';
                errorEl.style.display = 'none';

                const sendTwoFactorCode = firebase.functions().httpsCallable('sendTwoFactorCode');
                await sendTwoFactorCode({ email: twoFactorPendingEmail });

                resendLink.textContent = 'Sent!';

                // Re-enable after 30 seconds
                setTimeout(() => {
                    resendLink.textContent = 'Resend';
                    resendLink.style.pointerEvents = 'auto';
                }, 30000);

            } catch (error) {
                console.error('Resend code error:', error);
                resendLink.textContent = 'Resend';
                resendLink.style.pointerEvents = 'auto';
                errorEl.textContent = 'Failed to send code. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function closeTwoFactorSetupModal() {
            const toggle = document.getElementById('two-factor-toggle');
            toggle.disabled = false;

            if (twoFactorVerificationModal) {
                twoFactorVerificationModal.classList.remove('show');
                document.body.style.overflow = '';

                setTimeout(() => {
                    if (twoFactorVerificationModal) {
                        twoFactorVerificationModal.remove();
                        twoFactorVerificationModal = null;
                    }
                }, 300);
            }

            twoFactorPendingEmail = null;
        }

        // Handle direct toggle click
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('two-factor-toggle');
            if (toggle) {
                toggle.addEventListener('change', (e) => {
                    // Prevent default and trigger our custom toggle
                    e.preventDefault();
                    toggleTwoFactorAuth();
                });
            }
        });

        // ============================================
        // Referral Code Functions
        // ============================================

        const COUNTRIES = [
            "Argentina", "Australia", "Austria", "Belgium", "Brazil", "Bulgaria",
            "Canada", "Chile", "China", "Colombia", "Croatia", "Czech Republic",
            "Denmark", "Egypt", "Estonia", "Finland", "France", "Germany",
            "Greece", "Hungary", "Iceland", "India", "Indonesia", "Ireland",
            "Israel", "Italy", "Japan", "Jordan", "Kenya", "Latvia",
            "Lithuania", "Luxembourg", "Malaysia", "Mexico", "Morocco", "Netherlands",
            "New Zealand", "Norway", "Peru", "Philippines", "Poland", "Portugal",
            "Romania", "Russia", "Saudi Arabia", "Singapore", "Slovakia", "Slovenia",
            "South Africa", "South Korea", "Spain", "Sweden", "Switzerland", "Thailand",
            "Turkey", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Vietnam"
        ];

        const COUNTRY_TO_CODE = {
            "Argentina": "AR", "Australia": "AU", "Austria": "AT", "Belgium": "BE",
            "Brazil": "BR", "Bulgaria": "BG", "Canada": "CA", "Chile": "CL",
            "China": "CN", "Colombia": "CO", "Croatia": "HR", "Czech Republic": "CZ",
            "Denmark": "DK", "Egypt": "EG", "Estonia": "EE", "Finland": "FI",
            "France": "FR", "Germany": "DE", "Greece": "GR", "Hungary": "HU",
            "Iceland": "IS", "India": "IN", "Indonesia": "ID", "Ireland": "IE",
            "Israel": "IL", "Italy": "IT", "Japan": "JP", "Jordan": "JO",
            "Kenya": "KE", "Latvia": "LV", "Lithuania": "LT", "Luxembourg": "LU",
            "Malaysia": "MY", "Mexico": "MX", "Morocco": "MA", "Netherlands": "NL",
            "New Zealand": "NZ", "Norway": "NO", "Peru": "PE", "Philippines": "PH",
            "Poland": "PL", "Portugal": "PT", "Romania": "RO", "Russia": "RU",
            "Saudi Arabia": "SA", "Singapore": "SG", "Slovakia": "SK", "Slovenia": "SI",
            "South Africa": "ZA", "South Korea": "KR", "Spain": "ES", "Sweden": "SE",
            "Switzerland": "CH", "Thailand": "TH", "Turkey": "TR", "Ukraine": "UA",
            "United Arab Emirates": "AE", "United Kingdom": "GB", "United States": "US", "Vietnam": "VN"
        };

        function getFlagEmoji(countryCode) {
            if (!countryCode) return '';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }

        function generateReferralCode() {
            const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            return code;
        }

        async function loadReferralCode(userId) {
            try {
                const docRef = window.firebaseDb.collection('esimRewards').doc(userId);
                const doc = await docRef.get();
                const referralCodeEl = document.getElementById('referral-code');

                if (doc.exists && doc.data().referralCode) {
                    referralCodeEl.textContent = doc.data().referralCode;
                } else {
                    // Create new rewards profile with referral code
                    const newReferralCode = generateReferralCode();
                    const newRewardsProfile = {
                        totalCredits: 0,
                        totalSpend: 0,
                        level: 'Explorer',
                        referralCode: newReferralCode,
                        referralCount: 0,
                        referredBy: null,
                        hasReceivedReferralBonus: false,
                        creditsHistory: [],
                        preferredCurrency: 'USD',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await docRef.set(newRewardsProfile);
                    referralCodeEl.textContent = newReferralCode;
                }
            } catch (error) {
                console.error('Error loading referral code:', error);
            }
        }

        function copyReferralCode() {
            const code = document.getElementById('referral-code').textContent;
            if (code && code !== '--------') {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('Referral code copied!');
                }).catch(() => {
                    showToast('Failed to copy code');
                });
            }
        }

        // ============================================
        // User Preferences Functions
        // ============================================

        function populateCountryDropdown() {
            const select = document.getElementById('pref-home-country');
            if (!select) return;

            COUNTRIES.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = `${getFlagEmoji(COUNTRY_TO_CODE[country])} ${country}`;
                select.appendChild(option);
            });
        }

        async function loadUserPreferences(userId, profile) {
            try {
                // Load from user document
                const userDoc = await window.firebaseDb.collection('users').doc(userId).get();
                const userData = userDoc.exists ? userDoc.data() : {};

                // Home country
                const homeCountrySelect = document.getElementById('pref-home-country');
                if (homeCountrySelect && userData.homeCountry) {
                    homeCountrySelect.value = userData.homeCountry;
                }

                // Temperature unit
                const tempUnitSelect = document.getElementById('pref-temperature-unit');
                if (tempUnitSelect && userData.temperatureUnit) {
                    tempUnitSelect.value = userData.temperatureUnit;
                }

                // Passports
                const passportsDisplay = document.getElementById('pref-passports-display');
                if (passportsDisplay) {
                    if (userData.passports && userData.passports.length > 0) {
                        const flags = userData.passports.map(code => getFlagEmoji(code)).join(' ');
                        passportsDisplay.innerHTML = `<span style="font-size: 1.25rem; cursor: pointer;" onclick="openPassportsModal()">${flags}</span>`;
                    } else {
                        passportsDisplay.innerHTML = `<button onclick="openPassportsModal()" style="background: none; border: 1px solid var(--theme-border); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">Add passports</button>`;
                    }
                }
            } catch (error) {
                console.error('Error loading user preferences:', error);
            }
        }

        async function saveUserPreference(field, value) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                await window.firebaseDb.collection('users').doc(user.uid).set({
                    [field]: value
                }, { merge: true });

                showToast('Preference saved');
            } catch (error) {
                console.error('Error saving preference:', error);
                showToast('Failed to save preference');
            }
        }

        let selectedPassports = [];

        async function openPassportsModal() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            // Load current passports
            try {
                const userDoc = await window.firebaseDb.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().passports) {
                    selectedPassports = [...userDoc.data().passports];
                } else {
                    selectedPassports = [];
                }
            } catch (error) {
                selectedPassports = [];
            }

            // Create modal
            let modal = document.getElementById('passports-modal');
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = 'passports-modal';
            modal.className = 'passports-modal active';
            modal.innerHTML = `
                <div class="passports-modal-backdrop" onclick="closePassportsModal()"></div>
                <div class="passports-modal-content">
                    <div class="passports-modal-header">
                        <h3>Your Passports</h3>
                        <button class="passports-modal-close" onclick="closePassportsModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="passports-modal-body">
                        <input type="text" class="passports-search" id="passports-search" placeholder="Search countries..." oninput="filterPassports(this.value)">
                        <div class="passports-list" id="passports-list"></div>
                    </div>
                    <div class="passports-modal-footer">
                        <button class="passports-cancel-btn" onclick="closePassportsModal()">Cancel</button>
                        <button class="passports-save-btn" onclick="savePassports()">Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            renderPassportsList();
        }

        function closePassportsModal() {
            const modal = document.getElementById('passports-modal');
            if (modal) modal.remove();
        }

        function renderPassportsList(filter = '') {
            const list = document.getElementById('passports-list');
            if (!list) return;

            const filterLower = filter.toLowerCase();
            const filtered = COUNTRIES.filter(c => c.toLowerCase().includes(filterLower));

            list.innerHTML = filtered.map(country => {
                const code = COUNTRY_TO_CODE[country];
                const isSelected = selectedPassports.includes(code);
                return `
                    <label class="passport-item">
                        <input type="checkbox" value="${code}" ${isSelected ? 'checked' : ''} onchange="togglePassport('${code}')">
                        <span class="flag">${getFlagEmoji(code)}</span>
                        <span class="name">${country}</span>
                    </label>
                `;
            }).join('');
        }

        function filterPassports(value) {
            renderPassportsList(value);
        }

        function togglePassport(code) {
            const idx = selectedPassports.indexOf(code);
            if (idx > -1) {
                selectedPassports.splice(idx, 1);
            } else {
                selectedPassports.push(code);
            }
        }

        async function savePassports() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                await window.firebaseDb.collection('users').doc(user.uid).set({
                    passports: selectedPassports,
                    nationalities: selectedPassports
                }, { merge: true });

                // Update display
                const passportsDisplay = document.getElementById('pref-passports-display');
                if (passportsDisplay) {
                    if (selectedPassports.length > 0) {
                        const flags = selectedPassports.map(code => getFlagEmoji(code)).join(' ');
                        passportsDisplay.innerHTML = `<span style="font-size: 1.25rem; cursor: pointer;" onclick="openPassportsModal()">${flags}</span>`;
                    } else {
                        passportsDisplay.innerHTML = `<button onclick="openPassportsModal()" style="background: none; border: 1px solid var(--theme-border); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">Add passports</button>`;
                    }
                }

                closePassportsModal();
                showToast('Passports saved');
            } catch (error) {
                console.error('Error saving passports:', error);
                showToast('Failed to save passports');
            }
        }

        // ============================================
        // Friends Functions
        // ============================================

        async function loadFriends(userId) {
            const friendsList = document.getElementById('friends-list');
            const friendsEmpty = document.getElementById('friends-empty');
            const friendsCount = document.getElementById('friends-count');

            try {
                const snapshot = await window.firebaseDb
                    .collection('users')
                    .doc(userId)
                    .collection('friends')
                    .get();

                if (snapshot.empty) {
                    friendsList.innerHTML = '';
                    friendsEmpty.style.display = 'block';
                    friendsCount.style.display = 'none';
                    return;
                }

                friendsEmpty.style.display = 'none';
                friendsCount.style.display = 'inline';
                friendsCount.textContent = snapshot.size;

                let html = '';
                for (const doc of snapshot.docs) {
                    const friend = doc.data();
                    const friendId = doc.id;

                    // Get friend's profile
                    const friendProfile = await getFriendProfile(friendId);
                    const displayName = friendProfile?.displayName || friend.displayName || 'Friend';
                    const username = friendProfile?.username || friend.username || '';
                    const avatar = friendProfile?.profileImageURL || friendProfile?.photoURL;
                    const initials = displayName.charAt(0).toUpperCase();

                    html += `
                        <div class="friend-item" data-friend-id="${friendId}">
                            <div class="friend-avatar">
                                ${avatar ? `<img src="${avatar}" alt="${displayName}">` : initials}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${displayName}</div>
                                ${username ? `<div class="friend-username">@${username}</div>` : ''}
                            </div>
                            <button class="friend-remove-btn" onclick="removeFriend('${friendId}')" title="Remove friend">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }

                friendsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading friends:', error);
                friendsEmpty.style.display = 'block';
            }
        }

        async function getFriendProfile(friendId) {
            try {
                const doc = await window.firebaseDb.collection('users').doc(friendId).get();
                return doc.exists ? doc.data() : null;
            } catch (error) {
                console.error('Error getting friend profile:', error);
                return null;
            }
        }

        function openAddFriendModal() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('add-friend-modal');
            if (modal) {
                modal.remove();
            }

            modal = document.createElement('div');
            modal.id = 'add-friend-modal';
            modal.className = 'add-friend-modal active';
            modal.innerHTML = `
                <div class="add-friend-modal-backdrop" onclick="closeAddFriendModal()"></div>
                <div class="add-friend-modal-content">
                    <h3>Add Friend</h3>
                    <p style="color: var(--theme-text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">Enter your friend's username to send a friend request.</p>
                    <input type="text" id="friend-username-input" class="add-friend-input" placeholder="Username">
                    <div class="add-friend-error" id="friend-search-error"></div>
                    <div class="add-friend-actions">
                        <button class="add-friend-cancel" onclick="closeAddFriendModal()">Cancel</button>
                        <button class="add-friend-submit" onclick="sendFriendRequest()">Send Request</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('friend-username-input').focus();
        }

        function closeAddFriendModal() {
            const modal = document.getElementById('add-friend-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function sendFriendRequest() {
            const input = document.getElementById('friend-username-input');
            const errorEl = document.getElementById('friend-search-error');
            const username = input.value.trim().toLowerCase().replace('@', '');
            const user = firebase.auth().currentUser;

            if (!username) {
                errorEl.textContent = 'Please enter a username';
                errorEl.style.display = 'block';
                return;
            }

            try {
                // Search for user by username
                const snapshot = await window.firebaseDb
                    .collection('users')
                    .where('username', '==', username)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    errorEl.textContent = 'User not found';
                    errorEl.style.display = 'block';
                    return;
                }

                const targetUser = snapshot.docs[0];
                const targetUserId = targetUser.id;

                if (targetUserId === user.uid) {
                    errorEl.textContent = "You can't add yourself as a friend";
                    errorEl.style.display = 'block';
                    return;
                }

                // Check if already friends
                const existingFriend = await window.firebaseDb
                    .collection('users')
                    .doc(user.uid)
                    .collection('friends')
                    .doc(targetUserId)
                    .get();

                if (existingFriend.exists) {
                    errorEl.textContent = 'Already friends with this user';
                    errorEl.style.display = 'block';
                    return;
                }

                // Get current user's profile for the request
                const myProfile = await window.firebaseDb.collection('users').doc(user.uid).get();
                const myData = myProfile.exists ? myProfile.data() : {};

                // Create friend request
                await window.firebaseDb.collection('friendRequests').add({
                    fromUserId: user.uid,
                    fromUsername: myData.username || '',
                    fromDisplayName: myData.displayName || user.displayName || '',
                    toUserId: targetUserId,
                    toUsername: targetUser.data().username,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeAddFriendModal();
                showToast('Friend request sent!');
            } catch (error) {
                console.error('Error sending friend request:', error);
                errorEl.textContent = 'Failed to send request';
                errorEl.style.display = 'block';
            }
        }

        async function removeFriend(friendId) {
            if (!confirm('Are you sure you want to remove this friend?')) {
                return;
            }

            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                // Remove from both users' friends lists
                await window.firebaseDb
                    .collection('users')
                    .doc(user.uid)
                    .collection('friends')
                    .doc(friendId)
                    .delete();

                await window.firebaseDb
                    .collection('users')
                    .doc(friendId)
                    .collection('friends')
                    .doc(user.uid)
                    .delete();

                // Reload friends list
                loadFriends(user.uid);
                showToast('Friend removed');
            } catch (error) {
                console.error('Error removing friend:', error);
                showToast('Failed to remove friend');
            }
        }
    </script>
</body>
</html>
