<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/cookie-consent.css">
    <script src="js/cookie-consent.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your eSIM is ready! Scan the QR code to activate.">
    <title>eSIM Ready - TripPortier</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .success-hero {
            padding: 8rem 2rem 4rem;
            background: #0f0f23;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .success-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
        }

        .success-hero-content {
            position: relative;
            z-index: 2;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: #059669;
        }

        .success-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .success-hero p {
            font-size: 1.125rem;
            opacity: 0.95;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #059669;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #64748b;
            font-size: 1rem;
        }

        .loading-subtext {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            transition: opacity 0.3s ease;
        }

        .loading-progress {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            align-items: center;
            justify-content: center;
        }

        .loading-progress .step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: background 0.3s ease;
        }

        .loading-progress .step.active {
            background: #059669;
        }

        .loading-progress .step.warning {
            background: #f59e0b;
        }

        /* eSIM Details Section */
        .esim-section {
            padding: 3rem 2rem 4rem;
            background: #ffffff;
        }

        .esim-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .esim-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .esim-card-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .esim-card-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .esim-card-header p {
            color: #64748b;
        }

        .qr-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .qr-code {
            max-width: 250px;
            height: auto;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }

        .qr-instructions {
            margin-top: 1.5rem;
            color: #64748b;
            font-size: 0.9rem;
        }

        .esim-details {
            display: grid;
            gap: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
            text-align: right;
            word-break: break-all;
        }

        /* Installation Instructions */
        .install-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .install-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1.5rem;
        }

        .install-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .install-step {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .install-step:last-child {
            border-bottom: none;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            display: block;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .step-content span {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn-primary {
            flex: 1;
            min-width: 200px;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            flex: 1;
            min-width: 200px;
            padding: 1rem 2rem;
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #059669;
            color: #059669;
        }

        /* Email Confirmation */
        .email-notice {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .email-notice svg {
            width: 24px;
            height: 24px;
            color: #059669;
            flex-shrink: 0;
        }

        .email-notice p {
            color: #166534;
            font-size: 0.9rem;
            margin: 0;
        }

        .email-notice strong {
            display: block;
            color: #14532d;
        }

        /* Error State */
        .error-container {
            text-align: center;
            padding: 4rem 2rem;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .error-icon svg {
            width: 40px;
            height: 40px;
            color: #dc2626;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: #64748b;
            margin-bottom: 2rem;
        }

        /* Register Prompt Card */
        .register-prompt {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 1.5rem;
            padding: 2rem;
            color: white;
            margin-top: 2rem;
            text-align: center;
        }

        .register-prompt h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .register-prompt p {
            opacity: 0.95;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .register-benefits {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .register-benefit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .register-benefit svg {
            width: 20px;
            height: 20px;
        }

        .register-btn {
            display: inline-block;
            background: white;
            color: #6366f1;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Arrival Date Card */
        .arrival-card {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 2rem;
            border: 2px solid #e2e8f0;
        }

        .arrival-card.submitted {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .arrival-card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .arrival-card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .arrival-card-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .arrival-card-icon.success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .arrival-card-text h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 0.25rem;
        }

        .arrival-card-text p {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
        }

        .arrival-card-optional {
            display: inline-block;
            background: #ffffff;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .arrival-form {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .arrival-input-group {
            flex: 1;
            min-width: 200px;
        }

        .arrival-input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .arrival-input-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 1rem;
            color: #1e293b;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .arrival-input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .arrival-submit-btn {
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
            white-space: nowrap;
        }

        .arrival-submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .arrival-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .arrival-benefits {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.25rem;
            flex-wrap: wrap;
        }

        .arrival-benefit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .arrival-benefit svg {
            width: 18px;
            height: 18px;
            color: #10b981;
        }

        .arrival-success-message {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #bbf7d0;
        }

        .arrival-success-message svg {
            width: 24px;
            height: 24px;
            color: #10b981;
            flex-shrink: 0;
        }

        .arrival-success-message p {
            color: #166534;
            font-size: 0.9rem;
            margin: 0;
        }

        .arrival-success-message strong {
            display: block;
            color: #14532d;
        }

        /* Install Now Banner */
        .install-now-banner {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 1rem;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            color: white;
            animation: pulse-banner 2s ease-in-out infinite;
        }

        @keyframes pulse-banner {
            0%, 100% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 4px 30px rgba(16, 185, 129, 0.5); }
        }

        .install-now-banner svg {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .install-now-banner-text {
            flex: 1;
        }

        .install-now-banner-text strong {
            display: block;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .install-now-banner-text span {
            font-size: 0.875rem;
            opacity: 0.95;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .success-hero h1 {
                font-size: 1.75rem;
            }

            .esim-card, .install-card, .arrival-card {
                padding: 1.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                min-width: auto;
                width: 100%;
            }

            .arrival-form {
                flex-direction: column;
            }

            .arrival-submit-btn {
                width: 100%;
            }

            .arrival-benefits {
                flex-direction: column;
                gap: 0.75rem;
            }

            .arrival-card-header {
                flex-direction: column;
                text-align: center;
            }

            .arrival-card-icon {
                margin: 0 auto;
            }

            .install-now-banner {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    <!-- TrustBox script -->
    <script type="text/javascript" src="//widget.trustpilot.com/bootstrap/v5/tp.widget.bootstrap.min.js" async></script>
    <!-- End TrustBox script -->
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
      <!-- Row 1: Utility Bar -->
      <div class="nav-row-top">
        <div class="nav-row-container">
          <div class="nav-top-left">
            <a href="index.html" class="logo">
              <img src="assets/images/logo.png" alt="TripPortier Logo">
              TripPortier
            </a>
            <div class="nav-separator"></div>
            <div class="nav-currency-selector" id="navCurrencySelector">
              <button class="nav-selector-btn" id="currencyBtn" onclick="NavSelectors.toggleCurrency()">
                <span id="currencySymbol">$</span>
                <span id="currencyLabel">USD</span>
                <svg class="selector-chevron" width="12" height="12" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="nav-selector-dropdown" id="currencyDropdown"></div>
            </div>
            <div class="nav-language-selector" id="navLanguageSelector">
              <button class="nav-selector-btn" id="languageBtn" onclick="NavSelectors.toggleLanguage()">
                <span id="languageFlag">ðŸ‡¬ðŸ‡§</span>
                <span id="languageLabel">EN</span>
                <svg class="selector-chevron" width="12" height="12" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="nav-selector-dropdown" id="languageDropdown"></div>
            </div>
          </div>
          <div class="nav-top-right" id="navAuthArea"></div>
        </div>
      </div>
      <!-- Row 2: Main Navigation -->
      <div class="nav-row-main">
        <div class="nav-row-container">
          <ul class="nav-main-links">
            <li><a href="app.html" class="nav-main-link">ðŸ“± TripPortier App</a></li>
            <li><a href="esim.html" class="nav-main-link active">ðŸ“¶ eSIM</a></li>
            <li><a href="transport.html" class="nav-main-link">ðŸš— Transport</a></li>
            <li><a href="visa.html" class="nav-main-link">ðŸ“‹ Visa Check</a></li>
          </ul>
        </div>
      </div>
      <!-- Mobile: hamburger -->
      <div class="nav-mobile-toggle">
        <button class="mobile-menu" onclick="toggleMenu()">â˜°</button>
      </div>
      <!-- Mobile: slide-down panel -->
      <div class="mobile-nav-panel" id="mobileNavPanel">
        <ul class="mobile-nav-links">
          <li><a href="app.html">ðŸ“± TripPortier App</a></li>
          <li><a href="esim.html">ðŸ“¶ eSIM</a></li>
          <li><a href="transport.html">ðŸš— Transport</a></li>
          <li><a href="visa.html">ðŸ“‹ Visa Check</a></li>
        </ul>
        <div class="mobile-nav-divider"></div>
        <div class="mobile-selectors">
          <select id="mobileCurrencySelect" onchange="NavSelectors.setCurrency(this.value)"></select>
          <select id="mobileLanguageSelect" onchange="NavSelectors.setLanguage(this.value)"></select>
        </div>
        <div class="mobile-nav-divider"></div>
        <div id="mobileAuthSection"></div>
      </div>
    </nav>

    <!-- Success Hero -->
    <header class="success-hero">
        <div class="success-hero-content">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h1>Thank You for Your Purchase!</h1>
            <p>Your eSIM is ready - scan the QR code below to install</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="esim-section">
        <div class="esim-container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="spinner"></div>
                <p class="loading-text" id="loadingText">Loading your eSIM details...</p>
                <p class="loading-subtext" id="loadingSubtext">This usually takes 10-30 seconds</p>
                <div class="loading-progress">
                    <div class="step" id="step1"></div>
                    <div class="step" id="step2"></div>
                    <div class="step" id="step3"></div>
                    <div class="step" id="step4"></div>
                    <div class="step" id="step5"></div>
                </div>
            </div>

            <!-- Error State (hidden by default) -->
            <div id="errorState" style="display: none;">
                <div class="error-container">
                    <div class="error-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h2 class="error-title">Order Processing</h2>
                    <p class="error-message" id="errorMessage">Your order is still being processed. Please wait a moment and refresh the page.</p>
                    <p class="error-message" id="errorSessionId" style="font-size: 0.8rem; color: #94a3b8;"></p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn-primary" id="retryBtn" onclick="retryFetch()">Try Again</button>
                        <button class="btn-primary" style="background: #6366f1;" onclick="window.location.href='mailto:support@tripportier.com?subject=eSIM Order Issue&body=Session ID: ' + encodeURIComponent(getSessionId() || 'unknown')">Contact Support</button>
                    </div>
                </div>
            </div>

            <!-- Success State (hidden by default) -->
            <div id="successState" style="display: none;">
                <!-- Install Now Banner -->
                <div class="install-now-banner">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <div class="install-now-banner-text">
                        <strong>ðŸ“² Install your eSIM now while you have WiFi!</strong>
                        <span>Your data plan only starts when you connect at your destination. Install now so you're ready when you land.</span>
                    </div>
                </div>

                <!-- Email Notice -->
                <div class="email-notice">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <p>
                        <strong>Confirmation sent to <span id="customerEmail">your email</span></strong>
                        Please save this page or screenshot the QR code for offline access.
                    </p>
                </div>

                <!-- eSIM Card -->
                <div class="esim-card">
                    <div class="esim-card-header">
                        <h2 id="packageTitle">eSIM Package</h2>
                        <p id="packageSubtitle">Your eSIM for international travel</p>
                    </div>

                    <div class="qr-container">
                        <img id="qrCode" class="qr-code" src="" alt="eSIM QR Code">
                        <p class="qr-instructions">Scan this QR code with your phone's camera or go to Settings &gt; Cellular &gt; Add eSIM</p>
                    </div>

                    <div class="esim-details">
                        <div class="detail-row">
                            <span class="detail-label">Package</span>
                            <span class="detail-value" id="detailPackage">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Data</span>
                            <span class="detail-value" id="detailData">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Validity</span>
                            <span class="detail-value" id="detailValidity">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ICCID</span>
                            <span class="detail-value" id="detailIccid">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Order Reference</span>
                            <span class="detail-value" id="detailOrderCode">-</span>
                        </div>
                    </div>
                </div>

                <!-- Installation Instructions -->
                <div class="install-card">
                    <h3>How to Install Your eSIM</h3>

                    <!-- Important Notice -->
                    <div style="background: #fef3c7; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                        <p style="color: #92400e; font-size: 14px; margin: 0; font-weight: 600;">
                            IMPORTANT: Install your eSIM BEFORE you travel!
                        </p>
                        <p style="color: #92400e; font-size: 13px; margin: 8px 0 0 0;">
                            You need WiFi or mobile data to install. Your data plan only starts when you connect at your destination.
                        </p>
                    </div>

                    <!-- iPhone Instructions -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: #1e293b;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="5" y="2" width="14" height="20" rx="3" stroke="#1e293b" stroke-width="2"/>
                                <circle cx="12" cy="18" r="1" fill="#1e293b"/>
                            </svg>
                            For iPhone (iOS 12.1+)
                        </h4>
                        <ol class="install-steps">
                            <li class="install-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>Open Camera App</strong>
                                    <span>Point your iPhone's camera at the QR code above (don't take a photo, just point)</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Tap "Cellular Plan Detected"</strong>
                                    <span>A yellow notification will appear at the top of your screen - tap it</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>Tap "Continue" and "Add Cellular Plan"</strong>
                                    <span>Follow the prompts. When asked, you can label it "Travel" or your destination name</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>Choose "Secondary" for data</strong>
                                    <span>When asked about default line, choose your eSIM as secondary. You can change this later</span>
                                </div>
                            </li>
                        </ol>
                        <p style="color: #64748b; font-size: 13px; margin-top: 12px; padding: 10px; background: #ffffff; border-radius: 6px;">
                            <strong>Alternative:</strong> Go to Settings â†’ Cellular â†’ Add eSIM â†’ Use QR Code, then scan the QR code above
                        </p>
                    </div>

                    <!-- Android Instructions -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: #1e293b;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="5" y="2" width="14" height="20" rx="2" stroke="#1e293b" stroke-width="2"/>
                                <line x1="8" y1="19" x2="16" y2="19" stroke="#1e293b" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            For Android (varies by device)
                        </h4>
                        <ol class="install-steps">
                            <li class="install-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>Open Settings</strong>
                                    <span>Go to Settings â†’ Network & Internet â†’ SIMs (or Mobile Network)</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Add eSIM</strong>
                                    <span>Tap "+" or "Add" or "Download SIM" (wording varies by phone brand)</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>Scan QR Code</strong>
                                    <span>Select "Scan QR code" and point your camera at the QR code above</span>
                                </div>
                            </li>
                            <li class="install-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>Confirm and Download</strong>
                                    <span>Tap "Download" or "Confirm" - the eSIM will be installed in about 30 seconds</span>
                                </div>
                            </li>
                        </ol>
                        <p style="color: #64748b; font-size: 13px; margin-top: 12px; padding: 10px; background: #ffffff; border-radius: 6px;">
                            <strong>Samsung:</strong> Settings â†’ Connections â†’ SIM Manager â†’ Add eSIM<br>
                            <strong>Google Pixel:</strong> Settings â†’ Network & Internet â†’ SIMs â†’ Add SIM
                        </p>
                    </div>

                    <!-- When to Activate -->
                    <div style="background: #f0fdf4; border-radius: 8px; padding: 15px; border-left: 4px solid #10b981;">
                        <h4 style="color: #166534; margin: 0 0 10px 0; font-size: 15px;">When to Activate Your eSIM</h4>
                        <ul style="color: #166534; font-size: 14px; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Install now</strong> (while you have WiFi/data) - your plan won't start yet!</li>
                            <li><strong>Turn it ON when you land</strong> at your destination</li>
                            <li>Your data starts counting from your first connection abroad</li>
                            <li>Keep your regular SIM for calls/texts, use eSIM for data</li>
                        </ul>
                    </div>

                    <!-- Support Notice -->
                    <div style="margin-top: 20px; padding: 15px; background: #dcfce7; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <p style="color: #166534; font-size: 14px; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#22c55e">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            <span><strong>Need help?</strong> <a href="https://wa.me/41765125678" target="_blank" style="color: #166534; text-decoration: underline;">Message us on WhatsApp</a> and include your Order Reference.</span>
                        </p>
                    </div>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <a href="#" id="directInstallBtn" class="btn-primary" style="display: none;">
                            Install on This Device
                        </a>
                        <a href="esim.html" class="btn-secondary">
                            Browse More eSIMs
                        </a>
                    </div>
                </div>

                <!-- Arrival Date Card -->
                <div class="arrival-card" id="arrivalCard">
                    <div class="arrival-card-header">
                        <div class="arrival-card-icon" id="arrivalCardIcon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                        </div>
                        <div class="arrival-card-text">
                            <h3>Get a reminder to activate <span class="arrival-card-optional">Optional</span></h3>
                            <p>Enter your arrival date and we'll remind you to activate your eSIM when you land</p>
                        </div>
                    </div>

                    <!-- Form State -->
                    <div id="arrivalFormState">
                        <div class="arrival-form">
                            <div class="arrival-input-group">
                                <label for="arrivalDate">When do you arrive at your destination?</label>
                                <input type="date" id="arrivalDate" name="arrivalDate" required>
                            </div>
                            <button type="button" class="arrival-submit-btn" id="arrivalSubmitBtn" onclick="submitArrivalDate()">
                                Set Reminder
                            </button>
                        </div>
                        <div class="arrival-benefits">
                            <div class="arrival-benefit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Push notification on arrival day</span>
                            </div>
                            <div class="arrival-benefit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Email reminder to activate</span>
                            </div>
                        </div>
                    </div>

                    <!-- Success State -->
                    <div id="arrivalSuccessState" style="display: none;">
                        <div class="arrival-success-message">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>
                                <strong>Reminder set for <span id="arrivalDateDisplay">-</span></strong>
                                We'll send you a push notification and email on your arrival day to activate your eSIM.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Trustpilot Review Prompt -->
                <div class="trustpilot-review-card">
                    <div class="trustpilot-stars">
                        <span class="trustpilot-star"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                        <span class="trustpilot-star"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                        <span class="trustpilot-star"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                        <span class="trustpilot-star"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                        <span class="trustpilot-star"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                    </div>
                    <h3>Enjoying TripPortier?</h3>
                    <p>Your feedback helps other travelers find us</p>
                    <a href="https://www.trustpilot.com/review/tripportier.com" target="_blank" rel="noopener" class="trustpilot-review-btn">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        Review us on Trustpilot
                    </a>
                    <!-- TrustBox widget - Review Collector -->
                    <div class="trustpilot-widget" data-locale="en-US" data-template-id="56278e9abfbbba0bdcd568bc" data-businessunit-id="699ba09b1ca0c7c19a90b9d3" data-style-height="52px" data-style-width="100%" data-token="cde80f05-d946-496d-92ef-b24de7648d55" style="margin-top: 1rem;">
                        <a href="https://www.trustpilot.com/review/tripportier.com" target="_blank" rel="noopener">Trustpilot</a>
                    </div>
                    <!-- End TrustBox widget -->
                </div>

                <!-- Register Prompt (shown for non-logged-in users) -->
                <div class="register-prompt" id="registerPrompt" style="display: none;">
                    <h3>Save Your Order & Earn Rewards</h3>
                    <p>Create a free account to access your eSIM anytime, earn TripCoins cashback on every purchase, and get exclusive member benefits!</p>
                    <div class="register-benefits">
                        <div class="register-benefit">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Access eSIMs anytime</span>
                        </div>
                        <div class="register-benefit">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>3-15% cashback</span>
                        </div>
                        <div class="register-benefit">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                            </svg>
                            <span>Exclusive deals</span>
                        </div>
                    </div>
                    <a href="https://apps.apple.com/app/tripportier" class="register-btn">
                        Download the App
                    </a>
                    <p style="margin-top: 1rem; font-size: 0.85rem; opacity: 0.8;">
                        Your order will be automatically linked to your account
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section">
                <h4>TripPortier</h4>
                <p style="color: #94a3b8; margin-bottom: 1rem;">Your smart travel companion for stress-free trips.</p>
            </div>
            <div class="footer-section">
                <h4>Services</h4>
                <ul>
                    <li><a href="esim.html">eSIM</a></li>
                    <li><a href="airport-transfers.html">Airport Transfers</a></li>
                    <li><a href="visa.html">Visa Check</a></li>
                    <li><a href="https://asiatransport.tripportier.com" target="_blank">Asia Transport</a></li>
                    <li><a href="https://apps.apple.com/app/tripportier">Download App</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <ul>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="feature-request.html">Request Feature</a></li>
                    <li><a href="https://wa.me/41765125678">Contact Us</a></li>
                    <li><a href="https://www.trustpilot.com/review/tripportier.com" target="_blank" rel="noopener">Review us on Trustpilot</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms of Service</a></li>
                    <li><a href="attributions.html">Attributions</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <span>We accept:</span>
                <img src="images/payment-methods.png" alt="Visa, Mastercard, American Express, PayPal" class="payment-logos">
            </div>
            <p>&copy; 2025 TripPortier. All rights reserved.</p>
        </div>
    </footer>

    <!-- Footer JavaScript Functions -->
    <script>
        function changeCurrency(currency) {
            console.log('Currency changed to:', currency);
            // TODO: Implement currency switching logic
            // For now, just save preference
            localStorage.setItem('preferredCurrency', currency);
        }

        // Load saved preferences on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedCurrency = localStorage.getItem('preferredCurrency');

            if (savedCurrency) {
                const currencySelect = document.getElementById('currency-select');
                if (currencySelect) currencySelect.value = savedCurrency;
            }
        });
    </script>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/41765125678" class="whatsapp-float" target="_blank" aria-label="Contact us on WhatsApp">
        <svg viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
    </a>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- TripPortier Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-auth.js"></script>
    <script src="js/auth-ui.js"></script>
    <script src="js/main.js"></script>
    <script src="js/nav-selectors.js"></script>
    <script>
        // Use shared supabaseClient from supabase-config.js
        const supabase = supabaseClient;

        let currentUser = null;
        let currentOrderData = null;
        let retryCount = 0;
        let pollingTimer = null;
        const MAX_RETRIES = 30; // Max 60 seconds of polling (first 5 at 2s, rest at 3s)
        const INITIAL_POLL_INTERVAL = 2000; // 2s for first few attempts
        const POLL_INTERVAL = 3000; // 3s after that

        // Get session ID from URL
        function getSessionId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('session_id');
        }

        // Update loading progress UI
        function updateLoadingProgress() {
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');

            // Update progress dots
            const stepsToLight = Math.min(5, Math.ceil(retryCount / 6));
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                if (i <= stepsToLight) {
                    step.classList.add('active');
                    if (retryCount > 15) step.classList.add('warning');
                }
            }

            // Update messaging based on retry count
            if (retryCount >= 20) {
                loadingText.textContent = 'Still working on your eSIM...';
                loadingSubtext.textContent = 'This is taking longer than usual. We\'ll keep trying for a few more seconds.';
            } else if (retryCount >= 10) {
                loadingText.textContent = 'Preparing your eSIM...';
                loadingSubtext.textContent = 'Your payment was received. eSIM provisioning is in progress.';
            } else if (retryCount >= 3) {
                loadingText.textContent = 'Loading your eSIM details...';
                loadingSubtext.textContent = 'Connecting to eSIM provider...';
            }
        }

        // Retry fetch from error state
        function retryFetch() {
            retryCount = 0;
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'flex';
            // Reset progress dots
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                step.classList.remove('active', 'warning');
            }
            document.getElementById('loadingText').textContent = 'Loading your eSIM details...';
            document.getElementById('loadingSubtext').textContent = 'This usually takes 10-30 seconds';
            fetchOrderDetails();
        }

        // Fetch order details
        async function fetchOrderDetails() {
            const sessionId = getSessionId();

            if (!sessionId) {
                showError('No order session found. Please check your email for the order confirmation.');
                return;
            }

            try {
                const response = await fetch(`${FUNCTIONS_URL}/esim-order-by-session?session_id=${encodeURIComponent(sessionId)}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                    },
                });

                if (!response.ok) {
                    console.error('Edge Function error:', response.status, response.statusText);
                    // Retry on server errors, give up on client errors (except 429)
                    if (response.status >= 500 || response.status === 429) {
                        retryCount++;
                        updateLoadingProgress();
                        if (retryCount < MAX_RETRIES) {
                            const interval = retryCount <= 5 ? INITIAL_POLL_INTERVAL : POLL_INTERVAL;
                            pollingTimer = setTimeout(fetchOrderDetails, interval);
                            return;
                        }
                    }
                    showError('Failed to load order details. Please try the "Try Again" button or contact support.');
                    return;
                }

                const data = await response.json();

                if (data.success && data.order) {
                    showSuccess(data.order);
                } else if (data.status === 'processing') {
                    retryCount++;
                    updateLoadingProgress();
                    if (retryCount >= MAX_RETRIES) {
                        // Stop polling after max retries
                        showError('Your eSIM is taking longer than expected to provision. Your payment was received â€” please contact support@tripportier.com with your session ID so we can resolve this immediately.');
                        return;
                    }
                    // Order still processing, retry after delay
                    const interval = retryCount <= 5 ? INITIAL_POLL_INTERVAL : POLL_INTERVAL;
                    pollingTimer = setTimeout(fetchOrderDetails, interval);
                } else {
                    showError(data.error || 'Order not found. Please contact support if you completed a payment.');
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                // Retry on network errors instead of immediately showing error
                retryCount++;
                updateLoadingProgress();
                if (retryCount < MAX_RETRIES) {
                    const interval = retryCount <= 5 ? INITIAL_POLL_INTERVAL : POLL_INTERVAL;
                    pollingTimer = setTimeout(fetchOrderDetails, interval);
                    return;
                }
                showError('Failed to load order details. Please try the "Try Again" button or contact support.');
            }
        }

        // Show success state with order details
        function showSuccess(order) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';

            // Store order data for potential linking
            currentOrderData = order;

            // Show register prompt if not logged in
            updateRegisterPrompt();

            // Update email
            document.getElementById('customerEmail').textContent = order.email || 'your email';

            // Update package details
            document.getElementById('packageTitle').textContent = order.packageName || 'eSIM Package';
            document.getElementById('packageSubtitle').textContent = `Your eSIM for ${order.countryTitle || 'international travel'}`;

            // Update QR code
            const qrImg = document.getElementById('qrCode');
            if (order.qrCodeUrl) {
                qrImg.src = order.qrCodeUrl;
            } else {
                // Hide QR and show message
                qrImg.alt = 'QR Code will be sent to your email';
                qrImg.style.display = 'none';
                document.querySelector('.qr-instructions').textContent = 'Your eSIM QR code is being prepared. Please check your email.';
            }

            // Update details
            document.getElementById('detailPackage').textContent = order.packageName || '-';
            document.getElementById('detailData').textContent = order.data || '-';
            document.getElementById('detailValidity').textContent = order.days ? `${order.days} days` : '-';
            document.getElementById('detailIccid').textContent = order.iccid || '-';
            document.getElementById('detailOrderCode').textContent = order.orderCode || '-';

            // Show direct install button for iOS (if on mobile)
            if (order.directApple && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
                const directBtn = document.getElementById('directInstallBtn');
                directBtn.href = order.directApple;
                directBtn.style.display = 'block';
            }
        }

        // Show error state
        function showError(message) {
            if (pollingTimer) {
                clearTimeout(pollingTimer);
                pollingTimer = null;
            }
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            const sessionId = getSessionId();
            if (sessionId) {
                document.getElementById('errorSessionId').textContent = 'Session ID: ' + sessionId;
            }
        }

        // Update register prompt visibility based on auth state
        function updateRegisterPrompt() {
            const registerPrompt = document.getElementById('registerPrompt');
            if (currentUser) {
                // User is logged in, hide the prompt
                registerPrompt.style.display = 'none';
            } else {
                // User is not logged in, show the prompt
                registerPrompt.style.display = 'block';
            }
        }

        // Submit arrival date for reminder
        async function submitArrivalDate() {
            const arrivalDateInput = document.getElementById('arrivalDate');
            const arrivalDate = arrivalDateInput.value;

            if (!arrivalDate) {
                arrivalDateInput.focus();
                return;
            }

            const submitBtn = document.getElementById('arrivalSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Setting...';

            try {
                // Get order reference
                const orderCode = currentOrderData?.orderCode;
                const email = currentOrderData?.email;

                if (!orderCode || !email) {
                    throw new Error('Order data not found');
                }

                // Call Supabase Edge Function to create reminder
                const response = await fetch(`${FUNCTIONS_URL}/esim-reminder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create',
                        email: email,
                        orderCode: orderCode,
                        arrivalDate: arrivalDate,
                        packageName: currentOrderData?.packageName || 'eSIM',
                        countryTitle: currentOrderData?.countryTitle || 'your destination',
                    }),
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to set reminder');
                }

                // Show success state
                const formattedDate = new Date(arrivalDate + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                document.getElementById('arrivalDateDisplay').textContent = formattedDate;
                document.getElementById('arrivalFormState').style.display = 'none';
                document.getElementById('arrivalSuccessState').style.display = 'block';
                document.getElementById('arrivalCard').classList.add('submitted');
                document.getElementById('arrivalCardIcon').classList.add('success');

                console.log('Arrival reminder set for:', arrivalDate);

            } catch (error) {
                console.error('Error setting arrival reminder:', error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Set Reminder';
                alert('Failed to set reminder. Please try again.');
            }
        }

        // Set minimum date for arrival date input (today)
        function initArrivalDateInput() {
            const arrivalDateInput = document.getElementById('arrivalDate');
            if (arrivalDateInput) {
                const today = new Date().toISOString().split('T')[0];
                arrivalDateInput.min = today;

                // Set default to tomorrow if available
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                arrivalDateInput.value = tomorrow.toISOString().split('T')[0];
            }
        }

        // Link order to user account after login/registration
        async function linkOrderToUser(userId, orderCode) {
            if (!orderCode) return;

            try {
                // Update the esim_orders record to include the user_id
                const { error } = await supabase
                    .from('esim_orders')
                    .update({ user_id: userId })
                    .eq('order_code', orderCode);

                if (error) {
                    console.error('Error linking order:', error);
                } else {
                    console.log('Order linked to user:', userId);
                }
            } catch (error) {
                console.error('Error linking order to user:', error);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize arrival date input
            initArrivalDateInput();

            // Set up Supabase auth state listener
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session?.user) {
                    currentUser = session.user;
                    console.log('User logged in:', session.user.email);

                    // If we have order data, try to link it to the user
                    if (currentOrderData && currentOrderData.orderCode) {
                        await linkOrderToUser(session.user.id, currentOrderData.orderCode);
                    }

                    // Update UI
                    updateRegisterPrompt();
                } else {
                    currentUser = null;
                    updateRegisterPrompt();
                }
            });

            // Check current session
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session?.user) {
                    currentUser = session.user;
                    updateRegisterPrompt();
                }
            });

            // Fetch order details
            fetchOrderDetails();
        });
    </script>
</body>
</html>
