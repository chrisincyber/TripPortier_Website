<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Buy travel eSIM data for 200+ countries. Instant activation, no physical SIM needed. Stay connected worldwide with TripPortier.">
    <meta name="keywords" content="eSIM, travel SIM, international data, roaming, prepaid SIM, travel data">
    <meta property="og:title" content="Travel eSIM - TripPortier">
    <meta property="og:description" content="Instant eSIM data for 200+ destinations. No roaming fees, no physical SIM. Stay connected while traveling.">
    <title>Travel eSIM - TripPortier</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Hero Section */
        .esim-hero {
            padding: 8rem 2rem 4rem;
            background: var(--theme-hero-gradient);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .esim-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(2%, 2%); }
        }

        .esim-hero-content {
            position: relative;
            z-index: 2;
        }

        .esim-hero h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .esim-hero p {
            font-size: 1.25rem;
            opacity: 0.95;
            max-width: 700px;
            margin: 0 auto 2rem;
        }

        .esim-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        /* Search Section */
        .search-section {
            padding: 0 2rem;
            margin-top: -2rem;
            position: relative;
            z-index: 10;
        }

        .search-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .search-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            font-size: 1rem;
            background: transparent;
            outline: none;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .search-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        /* Category Tabs */
        .categories-section {
            padding: 3rem 2rem 2rem;
            background: #f8fafc;
        }

        .categories-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .category-tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .category-tab {
            padding: 0.875rem 1.75rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9375rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-tab:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .category-tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
            color: white;
        }

        /* Countries Grid */
        .countries-section {
            padding: 2rem 2rem 4rem;
            background: #f8fafc;
        }

        .countries-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .countries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .country-card {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b4e 100%);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            text-decoration: none;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .country-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
        }

        .country-flag {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .country-name {
            font-weight: 600;
            font-size: 1rem;
            color: white;
            margin-bottom: 0.5rem;
        }

        .country-price {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .country-price strong {
            color: white;
            font-weight: 700;
        }

        /* Regional Cards */
        .regional-card {
            padding: 2rem;
            border-radius: 20px;
        }

        .regional-countries {
            font-size: 0.8125rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        /* Worldwide Card */
        .worldwide-card {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2.5rem;
            text-align: left;
        }

        .worldwide-card .country-flag {
            width: 80px;
            height: 80px;
            margin: 0;
        }

        .worldwide-info {
            flex: 1;
            margin-left: 2rem;
        }

        .worldwide-card .country-name {
            font-size: 1.5rem;
            color: white;
        }

        .worldwide-card .country-price {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .worldwide-cta {
            padding: 1rem 2rem;
            background: white;
            color: #7c3aed;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: transform 0.2s;
        }

        .worldwide-cta:hover {
            transform: scale(1.05);
        }

        /* Language Selector */
        .language-selector {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 999;
        }

        .language-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .language-btn:hover {
            border-color: #6366f1;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.2);
        }

        .language-dropdown {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 8px;
            margin-bottom: 8px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
            min-width: 180px;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .language-option:hover {
            background: #f1f5f9;
        }

        .language-option.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            color: #6366f1;
            font-weight: 600;
        }

        .language-option .flag {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .language-selector {
                bottom: 90px;
                right: 15px;
            }
            .language-btn {
                padding: 10px 14px;
                font-size: 13px;
            }
        }

        /* Loading State */
        .loading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .skeleton-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        .skeleton-flag {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            margin: 0 auto 1rem;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 0.5rem;
        }

        .skeleton-price {
            height: 14px;
            width: 60%;
            margin: 0 auto;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* FAQ Section */
        .faq-section {
            padding: 4rem 2rem;
            background: white;
        }

        .faq-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .faq-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .faq-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .faq-header p {
            color: #64748b;
        }

        .faq-item {
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-question {
            padding: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .faq-question:hover {
            background: #f1f5f9;
        }

        .faq-icon {
            font-size: 1.25rem;
            transition: transform 0.3s;
        }

        .faq-item.open .faq-icon {
            transform: rotate(180deg);
        }

        .faq-answer {
            padding: 0 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            color: #64748b;
            line-height: 1.7;
        }

        .faq-item.open .faq-answer {
            padding: 0 1.5rem 1.5rem;
            max-height: 500px;
        }

        .faq-more {
            text-align: center;
            margin-top: 2rem;
        }

        .faq-more a {
            color: #6366f1;
            font-weight: 600;
            text-decoration: none;
        }

        .faq-more a:hover {
            text-decoration: underline;
        }

        /* Benefits Section */
        .benefits-section {
            padding: 4rem 2rem;
            background: #f8fafc;
        }

        .benefits-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .benefits-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .benefits-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .benefit-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        .benefit-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
        }

        .benefit-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .benefit-card p {
            color: #64748b;
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        /* Cashback Rewards Section */
        .cashback-section {
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .cashback-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.2) 0%, transparent 40%);
            animation: float 20s ease-in-out infinite;
        }

        .cashback-container {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .cashback-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }

        .cashback-text h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .cashback-text h2 span {
            background: linear-gradient(135deg, #22d3ee 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .cashback-text p {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            line-height: 1.7;
        }

        .cashback-tiers {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .cashback-tier {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .cashback-tier:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }

        .tier-badge {
            min-width: 60px;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 700;
            text-align: center;
        }

        .tier-info {
            flex: 1;
        }

        .tier-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.125rem;
        }

        .tier-requirement {
            font-size: 0.8125rem;
            opacity: 0.7;
        }

        .cashback-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .cashback-card-preview {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 2rem;
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .card-balance-label {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .card-balance {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #22d3ee 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .card-level {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .cashback-cta {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            background: white;
            color: #4c1d95;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .cashback-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .cashback-content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .cashback-text h2 {
                font-size: 1.75rem;
            }

            .cashback-visual {
                order: -1;
            }

            .card-balance {
                font-size: 2.5rem;
            }
        }

        /* App CTA */
        .app-cta {
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            text-align: center;
        }

        .app-cta h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .app-cta p {
            opacity: 0.95;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .esim-hero h1 {
                font-size: 2rem;
            }

            .esim-hero p {
                font-size: 1rem;
            }

            .search-box {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
            }

            .category-tabs {
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 0.5rem;
            }

            .category-tab {
                white-space: nowrap;
            }

            .countries-section {
                padding: 2rem 1rem 4rem;
            }

            .countries-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .country-card {
                padding: 1rem;
            }

            .country-flag {
                width: 56px;
                height: 56px;
            }

            .country-name {
                font-size: 0.9rem;
            }

            .country-features {
                gap: 0.4rem 0.6rem;
                flex-wrap: wrap;
                margin: 0.5rem 0;
            }

            .feature-badge {
                font-size: 0.7rem;
                padding: 0;
            }

            .feature-badge .check,
            .feature-badge .cross {
                font-size: 0.75rem;
            }

            .country-price {
                font-size: 0.8rem;
                margin-top: 0.25rem;
            }

            .country-price strong {
                font-size: 0.95rem;
            }

            .worldwide-card {
                flex-direction: column;
                text-align: center;
            }

            .worldwide-info {
                margin: 1.5rem 0;
            }
        }

        /* Country search dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .search-result-item span {
            font-weight: 500;
            color: #1e293b;
        }

        .search-wrapper {
            position: relative;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Feature indicators */
        .country-features {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .feature-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .feature-badge .check {
            color: #60a5fa;
            font-weight: bold;
        }

        .feature-badge .cross {
            color: rgba(255, 255, 255, 0.5);
        }

        .feature-badge.has-feature {
            color: white;
        }

        /* Price loading state */
        .price-loading {
            display: inline-block;
            width: 50px;
            height: 14px;
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            vertical-align: middle;
        }

        /* Detail Modal */
        .detail-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .detail-modal-overlay.show {
            display: flex;
        }

        .detail-modal {
            background: white;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .detail-modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10;
        }

        .detail-modal-close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            color: #64748b;
        }

        .detail-modal-flag {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .detail-modal-title h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .detail-modal-title p {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0.25rem 0 0;
        }

        .detail-modal-features {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9375rem;
        }

        .detail-feature .icon {
            font-size: 1.25rem;
        }

        .detail-feature.available {
            color: #10b981;
        }

        .detail-feature.unavailable {
            color: #94a3b8;
            text-decoration: line-through;
        }

        .detail-modal-body {
            padding: 1.5rem;
        }

        .packages-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .package-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .package-option:hover {
            border-color: #6366f1;
            background: white;
        }

        .package-option.selected {
            border-color: #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .package-option.expanded {
            flex-direction: column;
            align-items: stretch;
            border-color: #6366f1;
            background: white;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.15);
        }

        .package-option.expanded .package-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .package-details-expanded {
            display: none;
        }

        .package-option.expanded .package-details-expanded {
            display: block;
        }

        .package-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .package-detail-row:last-child {
            border-bottom: none;
        }

        .package-detail-label {
            color: #64748b;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .package-detail-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .package-detail-value.available {
            color: #059669;
        }

        .package-detail-value.unavailable {
            color: #94a3b8;
        }

        .validity-note {
            background: #f0fdf4;
            border-radius: 8px;
            padding: 12px;
            margin-top: 1rem;
            border-left: 3px solid #22c55e;
        }

        .validity-note p {
            margin: 0;
            font-size: 0.85rem;
            color: #166534;
        }

        .proceed-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proceed-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .package-info {
            flex: 1;
        }

        .package-data-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .package-validity {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .package-features-mini {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .package-features-mini span {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: white;
            border-radius: 4px;
            color: #64748b;
        }

        .package-features-mini span.has {
            background: #d1fae5;
            color: #065f46;
        }

        .package-price-tag {
            font-size: 1.5rem;
            font-weight: 800;
            color: #6366f1;
        }

        .detail-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            background: white;
            position: sticky;
            bottom: 0;
        }

        .buy-now-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .buy-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .buy-now-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .modal-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Filter & Sort Controls */
        .modal-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-tab:hover {
            border-color: #6366f1;
        }

        .filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .sort-select {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            min-width: 140px;
        }

        .sort-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Unlimited badge */
        .unlimited-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 0.5rem;
            text-transform: uppercase;
        }

        /* TripCoin Redemption */
        .tripcoins-section {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border-bottom: 1px solid #fcd34d;
        }

        .tripcoins-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .tripcoins-balance {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #92400e;
        }

        .tripcoins-balance .coin-icon {
            font-size: 1.25rem;
        }

        .tripcoins-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tripcoins-toggle label {
            font-size: 0.875rem;
            color: #92400e;
        }

        .tripcoins-toggle input[type="checkbox"] {
            width: 44px;
            height: 24px;
            appearance: none;
            background: #cbd5e1;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tripcoins-toggle input[type="checkbox"]:checked {
            background: #10b981;
        }

        .tripcoins-toggle input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .tripcoins-toggle input[type="checkbox"]:checked::before {
            transform: translateX(20px);
        }

        .tripcoins-slider-container {
            margin-top: 0.75rem;
        }

        .tripcoins-slider {
            width: 100%;
            height: 6px;
            appearance: none;
            background: #fcd34d;
            border-radius: 3px;
            outline: none;
        }

        .tripcoins-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f59e0b;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .tripcoins-info {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        .tripcoins-savings {
            font-weight: 600;
            color: #059669;
        }

        /* Checkout Modal */
        .checkout-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .checkout-modal-overlay.show {
            display: flex;
        }

        .checkout-modal-content {
            background: white;
            border-radius: 24px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .checkout-modal-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .checkout-modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .checkout-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            color: #64748b;
            transition: all 0.2s;
        }

        .checkout-modal-close:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .checkout-modal-body {
            padding: 1.5rem;
        }

        .checkout-package-summary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 12px;
            padding: 1.25rem;
            color: white;
            margin-bottom: 1.25rem;
        }

        .checkout-package-summary h4 {
            font-weight: 600;
            margin: 0 0 0.25rem;
        }

        .checkout-package-summary p {
            opacity: 0.9;
            font-size: 0.875rem;
            margin: 0;
        }

        .checkout-package-price {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .checkout-form-group {
            margin-bottom: 1rem;
        }

        .checkout-form-group label {
            display: block;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .checkout-form-group input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .checkout-form-group input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .checkout-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        @media (min-width: 768px) {
            .detail-modal-overlay {
                align-items: center;
                padding: 2rem;
            }

            .detail-modal {
                border-radius: 24px;
                max-height: 80vh;
            }
        }

        /* Language Selector Styles */
        .language-selector {
            position: relative;
            margin-left: 16px;
        }

        .language-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            transition: all 0.3s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .language-option:hover {
            background: #f3f4f6;
        }

        .language-option.active {
            background: #ede9fe;
            color: #7c3aed;
        }

        .language-option:first-child {
            border-radius: 12px 12px 0 0;
        }

        .language-option:last-child {
            border-radius: 0 0 12px 12px;
        }

        .language-option .flag {
            font-size: 20px;
        }

        .language-option .name {
            flex: 1;
        }

        /* RTL Support for Arabic */
        [dir="rtl"] {
            text-align: right;
        }

        [dir="rtl"] .nav-container,
        [dir="rtl"] .benefits-grid,
        [dir="rtl"] .countries-grid {
            direction: rtl;
        }

        @media (max-width: 768px) {
            .language-selector {
                margin-left: 8px;
            }

            .language-btn {
                padding: 6px 10px;
            }

            #currentLanguageName {
                display: none;
            }

            .language-dropdown {
                right: -50px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="TripPortier Logo">
                TripPortier
            </a>
            <ul class="nav-links">
                <li><a href="esim.html" class="active">eSIM</a></li>
                <li class="nav-dropdown">
                    <a href="#" class="dropdown-toggle">Transport <span class="dropdown-arrow">â–¼</span></a>
                    <ul class="dropdown-menu">
                        <li><a href="airport-transfers.html">Airport Transfers</a></li>
                        <li><a href="https://asiatransport.tripportier.com" target="_blank">Asia Transport</a></li>
                    </ul>
                </li>
                <li id="mytrips-nav" style="display: none;"><a href="trips.html">My Trips</a></li>
                <li id="premium-nav"><a href="premium.html">TripPortier+</a></li>
            </ul>

            <!-- Language Selector -->
            <div class="language-selector" id="languageSelector">
                <button class="language-btn" onclick="toggleLanguageDropdown()">
                    <span id="currentLanguageFlag">ðŸ‡¬ðŸ‡§</span>
                    <span id="currentLanguageName">EN</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
                <div class="language-dropdown" id="languageDropdown"></div>
            </div>

            <button class="mobile-menu" onclick="toggleMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="esim-hero">
        <div class="esim-hero-content">
            <div class="esim-badge">
                <span>&#128241;</span>
                <span data-i18n="hero.badge">Instant Digital SIM</span>
            </div>
            <h1 data-i18n="hero.title">Travel eSIM</h1>
            <p data-i18n="hero.description">Stay connected in 200+ destinations. Instant activation, no physical SIM card needed. Download your eSIM before you travel.</p>
        </div>
    </section>

    <!-- Search Section -->
    <section class="search-section">
        <div class="search-container">
            <div class="search-wrapper">
                <div class="search-box">
                    <input type="text" class="search-input" id="countrySearch" data-i18n-placeholder="search.placeholder" placeholder="Search for a country or region..." autocomplete="off">
                    <button class="search-btn" onclick="performSearch()">
                        <span data-i18n="search.button">Search</span>
                    </button>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
    </section>

    <!-- Category Tabs -->
    <section class="categories-section">
        <div class="categories-container">
            <div class="category-tabs">
                <button class="category-tab active" data-category="popular" onclick="switchCategory('popular')">
                    <span data-i18n="tabs.popular">Popular</span>
                </button>
                <button class="category-tab" data-category="local" onclick="switchCategory('local')">
                    <span data-i18n="tabs.local">Local</span>
                </button>
                <button class="category-tab" data-category="regional" onclick="switchCategory('regional')">
                    <span data-i18n="tabs.regional">Regional</span>
                </button>
                <button class="category-tab" data-category="global" onclick="switchCategory('global')">
                    <span data-i18n="tabs.worldwide">Worldwide</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Countries Grid -->
    <section class="countries-section">
        <div class="countries-container">
            <div class="section-header">
                <h2 class="section-title" id="sectionTitle" data-i18n="section.popularDestinations">Popular Destinations</h2>
            </div>
            <div class="countries-grid" id="countriesGrid">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Cashback Rewards Section -->
    <section class="cashback-section">
        <div class="cashback-container">
            <div class="cashback-content">
                <div class="cashback-text">
                    <h2 data-i18n="cashback.title">Earn <span>Up to 10% Cashback</span> on Every eSIM</h2>
                    <p data-i18n="cashback.description">The more you travel, the more you save. Our rewards program gives you real money back on every eSIM purchase. Your cashback never expires and can be used on future purchases.</p>

                    <div class="cashback-tiers">
                        <div class="cashback-tier">
                            <div class="tier-badge">3%</div>
                            <div class="tier-info">
                                <div class="tier-name" data-i18n="cashback.explorer">Explorer</div>
                                <div class="tier-requirement" data-i18n="cashback.explorerRequirement">Start earning immediately</div>
                            </div>
                        </div>
                        <div class="cashback-tier">
                            <div class="tier-badge">5%</div>
                            <div class="tier-info">
                                <div class="tier-name" data-i18n="cashback.adventurer">Adventurer</div>
                                <div class="tier-requirement" data-i18n="cashback.adventurerRequirement">After $25 in purchases</div>
                            </div>
                        </div>
                        <div class="cashback-tier">
                            <div class="tier-badge">7%</div>
                            <div class="tier-info">
                                <div class="tier-name" data-i18n="cashback.pioneer">Pioneer</div>
                                <div class="tier-requirement" data-i18n="cashback.pioneerRequirement">After $100 in purchases</div>
                            </div>
                        </div>
                        <div class="cashback-tier">
                            <div class="tier-badge">10%</div>
                            <div class="tier-info">
                                <div class="tier-name" data-i18n="cashback.ambassador">Ambassador</div>
                                <div class="tier-requirement" data-i18n="cashback.ambassadorRequirement">After $150 in purchases</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cashback-visual">
                    <div class="cashback-card-preview">
                        <div class="card-balance-label" data-i18n="cashback.yourBalance">Your Cashback Balance</div>
                        <div class="card-balance">$24.50</div>
                        <div class="card-level">Pioneer - 7%</div>
                    </div>
                    <a href="account.html" class="cashback-cta">
                        <span data-i18n="cashback.viewRewards">View Your Rewards</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Benefits Section -->
    <section class="benefits-section">
        <div class="benefits-container">
            <div class="benefits-header">
                <h2 data-i18n="benefits.title">Why Choose TripPortier eSIM?</h2>
            </div>
            <div class="benefits-grid">
                <div class="benefit-card">
                    <div class="benefit-icon">&#9889;</div>
                    <h3 data-i18n="benefits.instantActivation.title">Instant Activation</h3>
                    <p data-i18n="benefits.instantActivation.description">Get your eSIM delivered instantly via QR code. Scan, activate, and connect in minutes.</p>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">&#128176;</div>
                    <h3 data-i18n="benefits.noRoamingFees.title">No Roaming Fees</h3>
                    <p data-i18n="benefits.noRoamingFees.description">Save up to 90% compared to traditional roaming. Fixed prices with no hidden charges.</p>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">&#127760;</div>
                    <h3 data-i18n="benefits.globalCoverage.title">200+ Countries</h3>
                    <p data-i18n="benefits.globalCoverage.description">Coverage across the globe. Local, regional, and worldwide plans available.</p>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">&#128241;</div>
                    <h3 data-i18n="benefits.keepNumber.title">Keep Your Number</h3>
                    <p data-i18n="benefits.keepNumber.description">Your eSIM works alongside your regular SIM. No need to swap cards or change numbers.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="faq-section" id="faq">
        <div class="faq-container">
            <div class="faq-header">
                <h2 data-i18n="faq.title">eSIM FAQ</h2>
                <p data-i18n="faq.subtitle">Everything you need to know about travel eSIMs</p>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span data-i18n="faq.q1">What is an eSIM?</span>
                    <span class="faq-icon">&#9660;</span>
                </div>
                <div class="faq-answer" data-i18n="faq.a1">
                    An eSIM (embedded SIM) is a digital SIM that allows you to activate a mobile data plan without needing a physical SIM card. It's built into most modern smartphones (iPhone XS and newer, many Android devices). Perfect for travelers who want instant connectivity without swapping SIM cards or dealing with roaming charges.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span data-i18n="faq.q2">How do I install and activate an eSIM?</span>
                    <span class="faq-icon">&#9660;</span>
                </div>
                <div class="faq-answer" data-i18n="faq.a2">
                    <strong>Before traveling:</strong> Purchase your eSIM and scan the QR code while connected to WiFi. This installs the eSIM profile on your device.<br><br>
                    <strong>When you arrive:</strong> Go to your device settings, find the eSIM, and turn on data roaming. Your connection will activate automatically.<br><br>
                    <strong>Tip:</strong> Install before you leave home so everything is ready when you land!
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span data-i18n="faq.q3">Is my device compatible with eSIM?</span>
                    <span class="faq-icon">&#9660;</span>
                </div>
                <div class="faq-answer" data-i18n="faq.a3">
                    Most recent smartphones support eSIM, including:<br><br>
                    <strong>iPhone:</strong> XS, XR, 11, 12, 13, 14, 15, 16 and newer (including all Pro/Max versions)<br>
                    <strong>Samsung:</strong> Galaxy S20 and newer, Galaxy Z Fold/Flip series<br>
                    <strong>Google:</strong> Pixel 3 and newer<br>
                    <strong>Other:</strong> Many Huawei, Xiaomi, and other Android devices<br><br>
                    Your device must also be carrier-unlocked to use an eSIM from another provider.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span data-i18n="faq.q4">Can I keep my regular phone number?</span>
                    <span class="faq-icon">&#9660;</span>
                </div>
                <div class="faq-answer" data-i18n="faq.a4">
                    Yes! Your travel eSIM works alongside your existing SIM card. You'll have two lines on your phone - your regular number for calls/texts (you can disable data on this to avoid roaming) and your eSIM for affordable mobile data. You can receive calls and texts on your regular number while using eSIM data.
                </div>
            </div>

            <div class="faq-item">
                <div class="faq-question" onclick="toggleFaq(this)">
                    <span data-i18n="faq.q5">What happens if I run out of data?</span>
                    <span class="faq-icon">&#9660;</span>
                </div>
                <div class="faq-answer" data-i18n="faq.a5">
                    You can purchase a top-up or a new eSIM package at any time through the TripPortier app or website. We also send notifications when your data is running low so you're never caught off guard.
                </div>
            </div>

            <div class="faq-more">
                <a href="faq.html#esim"><span data-i18n="faq.viewAll">View all eSIM FAQs</span> &rarr;</a>
            </div>
        </div>
    </section>

    <!-- App CTA -->
    <section class="app-cta">
        <h2 data-i18n="app.title">Manage Your eSIMs in the App</h2>
        <p data-i18n="app.description">Download TripPortier to purchase eSIMs, track your data usage, and get activation reminders before your trip.</p>
        <a href="https://apps.apple.com/app/tripportier" class="btn btn-primary" style="background: white; color: #8b5cf6;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            <span data-i18n="app.download">Download on App Store</span>
        </a>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <!-- Trust Bar -->
        <div class="footer-trust-bar">
            <div class="trust-bar-container">
                <div class="trust-item">
                    <span class="trust-icon">&#128274;</span>
                    <span>Secure Payments</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#9989;</span>
                    <span>Verified Provider</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#128176;</span>
                    <span>Money-Back Guarantee</span>
                </div>
                <div class="trust-item">
                    <span class="trust-icon">&#127760;</span>
                    <span>200+ Countries</span>
                </div>
            </div>
        </div>
        <div class="footer-container">
            <div class="footer-section">
                <h4>TripPortier</h4>
                <p style="color: #94a3b8; margin-bottom: 1rem;">Your smart travel companion for stress-free trips.</p>
                <!-- Language & Currency Selectors -->
                <div class="footer-selectors">
                    <div class="selector-group">
                        <label for="footer-language-select">&#127760; Language</label>
                        <select id="footer-language-select" class="footer-select" onchange="changeLanguage(this.value)">
                            <option value="en">English</option>
                            <option value="de">Deutsch</option>
                            <option value="fr">FranÃ§ais</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="it">Italiano</option>
                            <option value="nl">Nederlands</option>
                            <option value="pt-BR">PortuguÃªs (BR)</option>
                            <option value="ja">æ—¥æœ¬èªž</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="zh-Hans">ç®€ä½“ä¸­æ–‡</option>
                            <option value="zh-Hant">ç¹é«”ä¸­æ–‡</option>
                            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="sv">Svenska</option>
                            <option value="da">Dansk</option>
                            <option value="nb">Norsk</option>
                            <option value="fi">Suomi</option>
                            <option value="th">à¹„à¸—à¸¢</option>
                            <option value="tr">TÃ¼rkÃ§e</option>
                        </select>
                    </div>
                    <div class="selector-group">
                        <label for="footer-currency-select">&#128176; Currency</label>
                        <select id="footer-currency-select" class="footer-select" onchange="changeCurrency(this.value)">
                            <option value="USD">$ USD</option>
                            <option value="EUR">â‚¬ EUR</option>
                            <option value="GBP">Â£ GBP</option>
                            <option value="CHF">CHF</option>
                            <option value="JPY">Â¥ JPY</option>
                            <option value="CNY">Â¥ CNY</option>
                            <option value="KRW">â‚© KRW</option>
                            <option value="AUD">$ AUD</option>
                            <option value="CAD">$ CAD</option>
                            <option value="NZD">$ NZD</option>
                            <option value="SGD">$ SGD</option>
                            <option value="HKD">$ HKD</option>
                            <option value="SEK">kr SEK</option>
                            <option value="NOK">kr NOK</option>
                            <option value="DKK">kr DKK</option>
                            <option value="THB">à¸¿ THB</option>
                            <option value="INR">â‚¹ INR</option>
                            <option value="BRL">R$ BRL</option>
                            <option value="MXN">$ MXN</option>
                            <option value="TRY">â‚º TRY</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="footer-section">
                <h4>Services</h4>
                <ul>
                    <li><a href="esim.html">eSIM</a></li>
                    <li><a href="airport-transfers.html">Airport Transfers</a></li>
                    <li><a href="https://asiatransport.tripportier.com" target="_blank">Asia Transport</a></li>
                    <li><a href="https://apps.apple.com/app/tripportier">Download App</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <ul>
                    <li><a href="faq.html">FAQ</a></li>
                    <li><a href="feature-request.html">Request Feature</a></li>
                    <li><a href="https://wa.me/41765125678">Contact Us</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms of Service</a></li>
                    <li><a href="attributions.html">Attributions</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <span>We accept:</span>
                <img src="https://cdn.jsdelivr.net/gh/nicepkg/assets@master/payment/visa.svg" alt="Visa" height="24">
                <img src="https://cdn.jsdelivr.net/gh/nicepkg/assets@master/payment/mastercard.svg" alt="Mastercard" height="24">
                <img src="https://cdn.jsdelivr.net/gh/nicepkg/assets@master/payment/amex.svg" alt="American Express" height="24">
                <img src="https://cdn.jsdelivr.net/gh/nicepkg/assets@master/payment/applepay.svg" alt="Apple Pay" height="24">
                <img src="https://cdn.jsdelivr.net/gh/nicepkg/assets@master/payment/googlepay.svg" alt="Google Pay" height="24">
            </div>
            <p>&copy; 2025 TripPortier. All rights reserved.</p>
        </div>
    </footer>

    <!-- Detail Modal -->
    <div class="detail-modal-overlay" id="detailModal">
        <div class="detail-modal">
            <div class="detail-modal-header">
                <img id="modalFlag" src="" alt="" class="detail-modal-flag">
                <div class="detail-modal-title">
                    <h2 id="modalTitle">Loading...</h2>
                    <p id="modalSubtitle"></p>
                </div>
                <button class="detail-modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-modal-features" id="modalFeatures">
                <!-- Filled by JS -->
            </div>
            <!-- Filter & Sort Controls -->
            <div class="modal-controls" id="modalControls" style="display: none;">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="setFilter('all')">
                        <span data-i18n="modal.filter.all">All</span>
                    </button>
                    <button class="filter-tab" data-filter="unlimited" onclick="setFilter('unlimited')">
                        <span data-i18n="modal.filter.unlimited">Unlimited</span>
                    </button>
                    <button class="filter-tab" data-filter="standard" onclick="setFilter('standard')">
                        <span data-i18n="modal.filter.standard">Standard</span>
                    </button>
                </div>
                <select class="sort-select" id="sortSelect" onchange="setSorting(this.value)">
                    <option value="price-asc" data-i18n="modal.sort.priceLowHigh">Price: Low to High</option>
                    <option value="price-desc" data-i18n="modal.sort.priceHighLow">Price: High to Low</option>
                    <option value="data-desc" data-i18n="modal.sort.dataMost">Data: Most First</option>
                    <option value="days-desc" data-i18n="modal.sort.durationLongest">Duration: Longest</option>
                </select>
            </div>
            <!-- TripCoin Redemption (shown for logged-in users with coins) -->
            <div class="tripcoins-section" id="tripcoinsSection" style="display: none;">
                <div class="tripcoins-header">
                    <div class="tripcoins-balance">
                        <span class="coin-icon">&#129689;</span>
                        <span>You have <strong id="tripcoinsBalance">0</strong> TripCoins</span>
                    </div>
                    <div class="tripcoins-toggle">
                        <label for="useTripcoins">Use coins</label>
                        <input type="checkbox" id="useTripcoins" onchange="toggleTripcoins()">
                    </div>
                </div>
                <div class="tripcoins-input-container" id="tripcoinsSlider" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="color: #64748b; font-size: 14px;">Use:</label>
                        <div style="display: flex; align-items: center; gap: 4px; flex: 1;">
                            <span style="color: #1e293b; font-weight: 600;">$</span>
                            <input type="number" class="tripcoins-input" id="tripcoinsAmount" min="1" max="100" value="1" oninput="updateTripcoinsAmount()" style="flex: 1; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
                            <span style="color: #64748b; font-size: 13px; white-space: nowrap;">of <span id="tripcoinsMaxAvailable">0</span></span>
                        </div>
                    </div>
                    <p style="margin: 8px 0 0; font-size: 13px; color: #059669; font-weight: 500;">You save: $<span id="tripcoinsSavings">0</span></p>
                </div>
            </div>
            <div class="detail-modal-body" id="modalBody">
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p data-i18n="modal.loading">Loading packages...</p>
                </div>
            </div>
            <div class="detail-modal-footer">
                <button class="buy-now-btn" id="buyNowBtn" disabled onclick="proceedToPurchase()">
                    <span data-i18n="modal.selectPackage">Select a package</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="checkout-modal-overlay" id="checkoutModal">
        <div class="checkout-modal-content">
            <button class="checkout-modal-close" onclick="closeCheckoutModal()">&times;</button>
            <div class="checkout-modal-header">
                <h3 data-i18n="checkout.title">Complete Your Purchase</h3>
            </div>
            <div class="checkout-modal-body">
                <div class="checkout-package-summary">
                    <h4 id="checkoutPackageName">5GB - 30 Days</h4>
                    <p id="checkoutPackageCountry">Japan</p>
                    <div class="checkout-package-price" id="checkoutPackagePrice">$12.00</div>
                </div>

                <!-- TripCoins Discount (shown when using coins) -->
                <div id="checkoutTripcoinsDiscount" style="display: none; background: linear-gradient(135deg, #fef3c7, #fef9c3); border-radius: 8px; padding: 12px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 6px; color: #92400e; font-weight: 600;">
                            <span style="font-size: 1.25rem;">&#129689;</span>
                            TripCoins Applied
                        </span>
                        <span style="color: #059669; font-weight: 700;">-$<span id="checkoutTripcoinsAmount">0</span></span>
                    </div>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; font-size: 14px;">
                        <span style="color: #64748b;"><s>$<span id="checkoutOriginalPrice">0</span></s></span>
                        <span style="color: #1e293b; font-weight: 600;">Final: $<span id="checkoutFinalPrice">0</span></span>
                    </div>
                </div>

                <div class="checkout-form-group">
                    <label for="checkoutEmailInput" data-i18n="checkout.email">Email Address</label>
                    <input type="email" id="checkoutEmailInput" placeholder="your@email.com" required>
                    <p style="font-size: 12px; color: #64748b; margin-top: 6px;" data-i18n="checkout.emailHint">Your eSIM QR code will be sent to this email</p>
                </div>

                <!-- TripCoins Earnings (shown for logged-in users) -->
                <div id="checkoutTripcoinsEarnings" style="display: none; background: linear-gradient(135deg, #dcfce7, #d1fae5); border-radius: 8px; padding: 12px; margin-bottom: 16px; border-left: 4px solid #22c55e;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 6px; color: #166534; font-weight: 600;">
                            <span style="font-size: 1.25rem;">&#129689;</span>
                            You'll earn on this purchase
                        </span>
                        <span style="color: #166534; font-weight: 700;">+$<span id="checkoutEarnAmount">0.00</span></span>
                    </div>
                    <p style="margin: 6px 0 0; font-size: 13px; color: #166534; opacity: 0.9;">
                        <span id="checkoutEarnPercent">5%</span> cashback as a <span id="checkoutUserLevel">Explorer</span> member
                    </p>
                </div>

                <!-- TripCoins Earnings Prompt (shown for guests) -->
                <div id="checkoutTripcoinsGuest" style="display: none; background: linear-gradient(135deg, #f3e8ff, #ede9fe); border-radius: 8px; padding: 12px; margin-bottom: 16px; border-left: 4px solid #a855f7;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 6px; color: #6b21a8; font-weight: 600;">
                            <span style="font-size: 1.25rem;">&#129689;</span>
                            Earn 3% cashback
                        </span>
                        <span style="color: #6b21a8; font-weight: 700;">+$<span id="checkoutEarnAmountGuest">0.00</span></span>
                    </div>
                    <p style="margin: 6px 0 8px; font-size: 13px; color: #6b21a8; opacity: 0.9;">
                        Create an account to earn on this purchase!
                    </p>
                    <a href="https://apps.apple.com/app/tripportier" style="display: inline-block; background: #a855f7; color: white; padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; text-decoration: none;">
                        Get the App
                    </a>
                </div>

                <button class="checkout-btn" id="checkoutBtn" onclick="proceedToStripeCheckout()">
                    <span data-i18n="checkout.continuePayment">Continue to Payment</span>
                </button>

                <!-- Checkout Trust Badges -->
                <div class="checkout-trust-badges">
                    <div class="checkout-trust-badge">
                        <span class="icon">&#128274;</span>
                        <span>Secure SSL</span>
                    </div>
                    <div class="checkout-trust-badge">
                        <span class="icon">&#128179;</span>
                        <span>Stripe Payments</span>
                    </div>
                    <div class="checkout-trust-badge">
                        <span class="icon">&#128176;</span>
                        <span>Money-Back</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Selector -->
    <div class="language-selector" id="languageSelector">
        <button class="language-btn" onclick="toggleLanguageDropdown()">
            <span id="currentLangFlag">ðŸ‡¬ðŸ‡§</span>
            <span id="currentLangName">English</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 15l-6-6-6 6"/>
            </svg>
        </button>
        <div class="language-dropdown" id="languageDropdown">
            <!-- Populated by JavaScript -->
        </div>
    </div>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/41765125678" class="whatsapp-float" target="_blank" aria-label="Contact us on WhatsApp">
        <svg viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
    </a>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check-compat.js"></script>

    <!-- TripPortier Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/auth-ui.js"></script>
    <script src="js/main.js"></script>

    <!-- Translation Scripts -->
    <script src="js/esim-translations.js"></script>
    <script src="js/esim-faq-translations.js"></script>
    <script>
        // ==========================================
        // Language & Translation System
        // ==========================================
        let currentLanguage = localStorage.getItem('esimLanguage') || 'en';

        // Initialize language dropdown
        function initLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            if (!dropdown || typeof languages === 'undefined') return;

            dropdown.innerHTML = languages.map(lang => `
                <button class="language-option ${lang.code === currentLanguage ? 'active' : ''}"
                        onclick="setLanguage('${lang.code}')">
                    <span class="flag">${lang.flag}</span>
                    <span class="name">${lang.nativeName}</span>
                </button>
            `).join('');
        }

        // Toggle language dropdown
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('languageDropdown')?.classList.remove('show');
            }
        });

        // Set language
        function setLanguage(langCode) {
            currentLanguage = langCode;
            localStorage.setItem('esimLanguage', langCode);

            // Update UI
            const lang = languages.find(l => l.code === langCode);
            if (lang) {
                document.getElementById('currentLanguageFlag').textContent = lang.flag;
                document.getElementById('currentLanguageName').textContent = langCode.toUpperCase().split('-')[0];
                document.body.dir = lang.dir || 'ltr';
            }

            // Update dropdown active state
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.toggle('active', opt.querySelector('.name')?.textContent === lang?.nativeName);
            });

            // Apply translations
            applyTranslations();
            document.getElementById('languageDropdown')?.classList.remove('show');
        }

        // Apply translations to all elements with data-i18n
        function applyTranslations() {
            const trans = translations[currentLanguage] || translations['en'];
            const faqTrans = faqTranslations[currentLanguage] || faqTranslations['en'];

            // Translate regular elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = getNestedValue(trans, key) || getNestedValue(faqTrans, key);
                if (value) el.textContent = value;
            });

            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const value = getNestedValue(trans, key);
                if (value) el.placeholder = value;
            });
        }

        // Get nested object value by dot-notation key
        function getNestedValue(obj, key) {
            return key.split('.').reduce((o, k) => o?.[k], obj);
        }

        // Localize country name using Intl.DisplayNames
        function localizeCountryName(countryCode) {
            try {
                const langCode = currentLanguage.replace('-', '-');
                const displayNames = new Intl.DisplayNames([langCode], { type: 'region' });
                return displayNames.of(countryCode.toUpperCase()) || countryCode;
            } catch {
                return countryCode;
            }
        }

        // Initialize language system on page load
        document.addEventListener('DOMContentLoaded', () => {
            initLanguageDropdown();
            // Set initial language from storage
            const lang = languages?.find(l => l.code === currentLanguage);
            if (lang) {
                document.getElementById('currentLanguageFlag').textContent = lang.flag;
                document.getElementById('currentLanguageName').textContent = currentLanguage.toUpperCase().split('-')[0];
                document.body.dir = lang.dir || 'ltr';
            }
            applyTranslations();
        });

        // ==========================================
        // eSIM Store Data & Functions
        // ==========================================
        const API_URL = 'https://us-central1-tripportier.cloudfunctions.net';

        // Cache for package data
        const packageCache = {};
        let currentModalData = null;
        let selectedPackage = null;

        // Filter & Sort state
        let currentFilter = 'all';
        let currentSort = 'price-asc';
        let allPackages = []; // Original unfiltered packages

        // TripCoins state
        let userTripcoins = 0;
        let tripcoinsToUse = 0;
        let usingTripcoins = false;

        // Popular destinations (same as app)
        const popularCountries = [
            { code: 'US', name: 'United States', flag: 'https://flagcdn.com/w80/us.png' },
            { code: 'JP', name: 'Japan', flag: 'https://flagcdn.com/w80/jp.png' },
            { code: 'TH', name: 'Thailand', flag: 'https://flagcdn.com/w80/th.png' },
            { code: 'GB', name: 'United Kingdom', flag: 'https://flagcdn.com/w80/gb.png' },
            { code: 'FR', name: 'France', flag: 'https://flagcdn.com/w80/fr.png' },
            { code: 'IT', name: 'Italy', flag: 'https://flagcdn.com/w80/it.png' },
            { code: 'ES', name: 'Spain', flag: 'https://flagcdn.com/w80/es.png' },
            { code: 'DE', name: 'Germany', flag: 'https://flagcdn.com/w80/de.png' },
            { code: 'AU', name: 'Australia', flag: 'https://flagcdn.com/w80/au.png' },
            { code: 'KR', name: 'South Korea', flag: 'https://flagcdn.com/w80/kr.png' },
            { code: 'SG', name: 'Singapore', flag: 'https://flagcdn.com/w80/sg.png' },
            { code: 'AE', name: 'UAE', flag: 'https://flagcdn.com/w80/ae.png' }
        ];

        // All countries (grouped alphabetically)
        const allCountries = [
            { code: 'AF', name: 'Afghanistan', flag: 'https://flagcdn.com/w80/af.png' },
            { code: 'AL', name: 'Albania', flag: 'https://flagcdn.com/w80/al.png' },
            { code: 'DZ', name: 'Algeria', flag: 'https://flagcdn.com/w80/dz.png' },
            { code: 'AR', name: 'Argentina', flag: 'https://flagcdn.com/w80/ar.png' },
            { code: 'AU', name: 'Australia', flag: 'https://flagcdn.com/w80/au.png' },
            { code: 'AT', name: 'Austria', flag: 'https://flagcdn.com/w80/at.png' },
            { code: 'BE', name: 'Belgium', flag: 'https://flagcdn.com/w80/be.png' },
            { code: 'BR', name: 'Brazil', flag: 'https://flagcdn.com/w80/br.png' },
            { code: 'BG', name: 'Bulgaria', flag: 'https://flagcdn.com/w80/bg.png' },
            { code: 'KH', name: 'Cambodia', flag: 'https://flagcdn.com/w80/kh.png' },
            { code: 'CA', name: 'Canada', flag: 'https://flagcdn.com/w80/ca.png' },
            { code: 'CL', name: 'Chile', flag: 'https://flagcdn.com/w80/cl.png' },
            { code: 'CN', name: 'China', flag: 'https://flagcdn.com/w80/cn.png' },
            { code: 'CO', name: 'Colombia', flag: 'https://flagcdn.com/w80/co.png' },
            { code: 'HR', name: 'Croatia', flag: 'https://flagcdn.com/w80/hr.png' },
            { code: 'CY', name: 'Cyprus', flag: 'https://flagcdn.com/w80/cy.png' },
            { code: 'CZ', name: 'Czech Republic', flag: 'https://flagcdn.com/w80/cz.png' },
            { code: 'DK', name: 'Denmark', flag: 'https://flagcdn.com/w80/dk.png' },
            { code: 'EG', name: 'Egypt', flag: 'https://flagcdn.com/w80/eg.png' },
            { code: 'EE', name: 'Estonia', flag: 'https://flagcdn.com/w80/ee.png' },
            { code: 'FI', name: 'Finland', flag: 'https://flagcdn.com/w80/fi.png' },
            { code: 'FR', name: 'France', flag: 'https://flagcdn.com/w80/fr.png' },
            { code: 'DE', name: 'Germany', flag: 'https://flagcdn.com/w80/de.png' },
            { code: 'GR', name: 'Greece', flag: 'https://flagcdn.com/w80/gr.png' },
            { code: 'HK', name: 'Hong Kong', flag: 'https://flagcdn.com/w80/hk.png' },
            { code: 'HU', name: 'Hungary', flag: 'https://flagcdn.com/w80/hu.png' },
            { code: 'IS', name: 'Iceland', flag: 'https://flagcdn.com/w80/is.png' },
            { code: 'IN', name: 'India', flag: 'https://flagcdn.com/w80/in.png' },
            { code: 'ID', name: 'Indonesia', flag: 'https://flagcdn.com/w80/id.png' },
            { code: 'IE', name: 'Ireland', flag: 'https://flagcdn.com/w80/ie.png' },
            { code: 'IL', name: 'Israel', flag: 'https://flagcdn.com/w80/il.png' },
            { code: 'IT', name: 'Italy', flag: 'https://flagcdn.com/w80/it.png' },
            { code: 'JP', name: 'Japan', flag: 'https://flagcdn.com/w80/jp.png' },
            { code: 'JO', name: 'Jordan', flag: 'https://flagcdn.com/w80/jo.png' },
            { code: 'KZ', name: 'Kazakhstan', flag: 'https://flagcdn.com/w80/kz.png' },
            { code: 'KE', name: 'Kenya', flag: 'https://flagcdn.com/w80/ke.png' },
            { code: 'KR', name: 'South Korea', flag: 'https://flagcdn.com/w80/kr.png' },
            { code: 'KW', name: 'Kuwait', flag: 'https://flagcdn.com/w80/kw.png' },
            { code: 'LV', name: 'Latvia', flag: 'https://flagcdn.com/w80/lv.png' },
            { code: 'LT', name: 'Lithuania', flag: 'https://flagcdn.com/w80/lt.png' },
            { code: 'LU', name: 'Luxembourg', flag: 'https://flagcdn.com/w80/lu.png' },
            { code: 'MO', name: 'Macau', flag: 'https://flagcdn.com/w80/mo.png' },
            { code: 'MY', name: 'Malaysia', flag: 'https://flagcdn.com/w80/my.png' },
            { code: 'MV', name: 'Maldives', flag: 'https://flagcdn.com/w80/mv.png' },
            { code: 'MT', name: 'Malta', flag: 'https://flagcdn.com/w80/mt.png' },
            { code: 'MX', name: 'Mexico', flag: 'https://flagcdn.com/w80/mx.png' },
            { code: 'MA', name: 'Morocco', flag: 'https://flagcdn.com/w80/ma.png' },
            { code: 'NL', name: 'Netherlands', flag: 'https://flagcdn.com/w80/nl.png' },
            { code: 'NZ', name: 'New Zealand', flag: 'https://flagcdn.com/w80/nz.png' },
            { code: 'NO', name: 'Norway', flag: 'https://flagcdn.com/w80/no.png' },
            { code: 'OM', name: 'Oman', flag: 'https://flagcdn.com/w80/om.png' },
            { code: 'PK', name: 'Pakistan', flag: 'https://flagcdn.com/w80/pk.png' },
            { code: 'PE', name: 'Peru', flag: 'https://flagcdn.com/w80/pe.png' },
            { code: 'PH', name: 'Philippines', flag: 'https://flagcdn.com/w80/ph.png' },
            { code: 'PL', name: 'Poland', flag: 'https://flagcdn.com/w80/pl.png' },
            { code: 'PT', name: 'Portugal', flag: 'https://flagcdn.com/w80/pt.png' },
            { code: 'QA', name: 'Qatar', flag: 'https://flagcdn.com/w80/qa.png' },
            { code: 'RO', name: 'Romania', flag: 'https://flagcdn.com/w80/ro.png' },
            { code: 'RU', name: 'Russia', flag: 'https://flagcdn.com/w80/ru.png' },
            { code: 'SA', name: 'Saudi Arabia', flag: 'https://flagcdn.com/w80/sa.png' },
            { code: 'RS', name: 'Serbia', flag: 'https://flagcdn.com/w80/rs.png' },
            { code: 'SG', name: 'Singapore', flag: 'https://flagcdn.com/w80/sg.png' },
            { code: 'SK', name: 'Slovakia', flag: 'https://flagcdn.com/w80/sk.png' },
            { code: 'SI', name: 'Slovenia', flag: 'https://flagcdn.com/w80/si.png' },
            { code: 'ZA', name: 'South Africa', flag: 'https://flagcdn.com/w80/za.png' },
            { code: 'ES', name: 'Spain', flag: 'https://flagcdn.com/w80/es.png' },
            { code: 'LK', name: 'Sri Lanka', flag: 'https://flagcdn.com/w80/lk.png' },
            { code: 'SE', name: 'Sweden', flag: 'https://flagcdn.com/w80/se.png' },
            { code: 'CH', name: 'Switzerland', flag: 'https://flagcdn.com/w80/ch.png' },
            { code: 'TW', name: 'Taiwan', flag: 'https://flagcdn.com/w80/tw.png' },
            { code: 'TH', name: 'Thailand', flag: 'https://flagcdn.com/w80/th.png' },
            { code: 'TR', name: 'Turkey', flag: 'https://flagcdn.com/w80/tr.png' },
            { code: 'UA', name: 'Ukraine', flag: 'https://flagcdn.com/w80/ua.png' },
            { code: 'AE', name: 'UAE', flag: 'https://flagcdn.com/w80/ae.png' },
            { code: 'GB', name: 'United Kingdom', flag: 'https://flagcdn.com/w80/gb.png' },
            { code: 'US', name: 'United States', flag: 'https://flagcdn.com/w80/us.png' },
            { code: 'VN', name: 'Vietnam', flag: 'https://flagcdn.com/w80/vn.png' }
        ];

        // Regional packages
        const regionalPackages = [
            { code: 'europe', name: 'Europe', flag: 'https://flagcdn.com/w80/eu.png', countries: '39 countries' },
            { code: 'asia', name: 'Asia', flag: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/Asia_%28orthographic_projection%29.svg/200px-Asia_%28orthographic_projection%29.svg.png', countries: '26 countries' },
            { code: 'north-america', name: 'North America', flag: 'https://flagcdn.com/w80/us.png', countries: 'USA, Canada, Mexico' },
            { code: 'latin-america', name: 'Latin America', flag: 'https://flagcdn.com/w80/br.png', countries: '17 countries' },
            { code: 'mena', name: 'Middle East', flag: 'https://flagcdn.com/w80/ae.png', countries: '12 countries' },
            { code: 'africa', name: 'Africa', flag: 'https://flagcdn.com/w80/za.png', countries: '25 countries' },
            { code: 'oceania', name: 'Oceania', flag: 'https://flagcdn.com/w80/au.png', countries: 'Australia, NZ + more' },
            { code: 'caribbean', name: 'Caribbean', flag: 'https://flagcdn.com/w80/jm.png', countries: '21 countries' },
            { code: 'eu-uk', name: 'Europe + UK', flag: 'https://flagcdn.com/w80/eu.png', countries: '40 countries' }
        ];

        // Current category
        let currentCategory = 'popular';

        // Fetch packages for a destination
        async function fetchPackages(type, code, region) {
            const cacheKey = `${type}_${code || region || 'global'}`;
            if (packageCache[cacheKey]) {
                return packageCache[cacheKey];
            }

            try {
                let url = `${API_URL}/getAiraloPackagesHttp?`;
                if (type === 'local' && code) {
                    url += `countryCode=${code}&type=local`;
                } else if (type === 'regional' && region) {
                    url += `type=regional&region=${region}`;
                } else {
                    url += `type=global`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.packages) {
                    packageCache[cacheKey] = data.packages;
                    return data.packages;
                }
            } catch (error) {
                console.error('Error fetching packages:', error);
            }
            return [];
        }

        // Get cheapest package info
        function getCheapestPackage(packages) {
            if (!packages || packages.length === 0) return null;
            return packages.reduce((min, pkg) => pkg.price < min.price ? pkg : min, packages[0]);
        }

        // Check if any package has voice/text
        function getFeatures(packages) {
            if (!packages || packages.length === 0) return { hasData: true, hasVoice: false, hasText: false };
            return {
                hasData: true,
                hasVoice: packages.some(p => p.hasVoice),
                hasText: packages.some(p => p.hasText)
            };
        }

        // Switch category
        function switchCategory(category) {
            currentCategory = category;

            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                }
            });

            const titles = {
                popular: 'Popular Destinations',
                local: 'All Countries',
                regional: 'Regional Plans',
                global: 'Worldwide Coverage'
            };
            document.getElementById('sectionTitle').textContent = titles[category];

            renderGrid(category);
        }

        // Render grid based on category
        function renderGrid(category) {
            const grid = document.getElementById('countriesGrid');

            if (category === 'popular') {
                grid.innerHTML = popularCountries.map(c => createCountryCard(c)).join('');
                loadPricesForCountries(popularCountries);
            } else if (category === 'local') {
                grid.innerHTML = allCountries.map(c => createCountryCard(c)).join('');
                loadPricesForCountries(allCountries);
            } else if (category === 'regional') {
                grid.innerHTML = regionalPackages.map(r => createRegionalCard(r)).join('');
                loadPricesForRegions(regionalPackages);
            } else if (category === 'global') {
                grid.innerHTML = createWorldwideCard();
                loadGlobalPrice();
            }
        }

        // Create country card with feature badges
        function createCountryCard(country) {
            return `
                <div class="country-card" onclick="openCountryModal('${country.code}', '${country.name}', '${country.flag}')">
                    <img src="${country.flag}" alt="${country.name}" class="country-flag" onerror="this.src='assets/images/flag-placeholder.png'">
                    <div class="country-name">${country.name}</div>
                    <div class="country-features" id="features-${country.code}">
                        <span class="feature-badge"><span class="check">&#10003;</span> Data</span>
                        <span class="feature-badge" id="sms-${country.code}"><span class="cross">&#10007;</span> SMS</span>
                        <span class="feature-badge" id="calls-${country.code}"><span class="cross">&#10007;</span> Calls</span>
                    </div>
                    <div class="country-price" id="price-${country.code}">From <span class="price-loading"></span></div>
                </div>
            `;
        }

        // Create regional card
        function createRegionalCard(region) {
            return `
                <div class="country-card regional-card" onclick="openRegionModal('${region.code}', '${region.name}', '${region.flag}', '${region.countries}')">
                    <img src="${region.flag}" alt="${region.name}" class="country-flag" onerror="this.src='assets/images/flag-placeholder.png'">
                    <div class="country-name">${region.name}</div>
                    <div class="country-features" id="features-region-${region.code}">
                        <span class="feature-badge"><span class="check">&#10003;</span> Data</span>
                        <span class="feature-badge" id="sms-region-${region.code}"><span class="cross">&#10007;</span> SMS</span>
                        <span class="feature-badge" id="calls-region-${region.code}"><span class="cross">&#10007;</span> Calls</span>
                    </div>
                    <div class="country-price" id="price-region-${region.code}">From <span class="price-loading"></span></div>
                    <div class="regional-countries">${region.countries}</div>
                </div>
            `;
        }

        // Create worldwide card
        function createWorldwideCard() {
            return `
                <div class="country-card worldwide-card" onclick="openGlobalModal()">
                    <div style="font-size: 4rem;">&#127758;</div>
                    <div class="worldwide-info">
                        <div class="country-name">Worldwide Coverage</div>
                        <div class="country-features" style="justify-content: flex-start; margin-top: 0.5rem;">
                            <span class="feature-badge"><span class="check">&#10003;</span> Data</span>
                            <span class="feature-badge" id="sms-global"><span class="cross">&#10007;</span> SMS</span>
                            <span class="feature-badge" id="calls-global"><span class="cross">&#10007;</span> Calls</span>
                        </div>
                        <div class="country-price" id="price-global" style="margin-top: 0.5rem;">From <span class="price-loading"></span></div>
                    </div>
                    <span class="worldwide-cta">View Plans</span>
                </div>
            `;
        }

        // Load prices for countries
        async function loadPricesForCountries(countries) {
            for (const country of countries) {
                const packages = await fetchPackages('local', country.code);
                const cheapest = getCheapestPackage(packages);
                const features = getFeatures(packages);

                const priceEl = document.getElementById(`price-${country.code}`);
                const smsEl = document.getElementById(`sms-${country.code}`);
                const callsEl = document.getElementById(`calls-${country.code}`);

                if (priceEl && cheapest) {
                    priceEl.innerHTML = `From <strong>$${cheapest.price.toFixed(2)}</strong>`;
                } else if (priceEl) {
                    priceEl.innerHTML = `<span style="color:#94a3b8">No packages</span>`;
                }

                if (smsEl && features.hasText) {
                    smsEl.innerHTML = `<span class="check">&#10003;</span> SMS`;
                    smsEl.classList.add('has-feature');
                }
                if (callsEl && features.hasVoice) {
                    callsEl.innerHTML = `<span class="check">&#10003;</span> Calls`;
                    callsEl.classList.add('has-feature');
                }
            }
        }

        // Load prices for regions
        async function loadPricesForRegions(regions) {
            for (const region of regions) {
                const packages = await fetchPackages('regional', null, region.code);
                const cheapest = getCheapestPackage(packages);
                const features = getFeatures(packages);

                const priceEl = document.getElementById(`price-region-${region.code}`);
                const smsEl = document.getElementById(`sms-region-${region.code}`);
                const callsEl = document.getElementById(`calls-region-${region.code}`);

                if (priceEl && cheapest) {
                    priceEl.innerHTML = `From <strong>$${cheapest.price.toFixed(2)}</strong>`;
                } else if (priceEl) {
                    priceEl.innerHTML = `<span style="color:rgba(255,255,255,0.6)">No packages</span>`;
                }

                if (smsEl && features.hasText) {
                    smsEl.innerHTML = `<span class="check">&#10003;</span> SMS`;
                    smsEl.classList.add('has-feature');
                }
                if (callsEl && features.hasVoice) {
                    callsEl.innerHTML = `<span class="check">&#10003;</span> Calls`;
                    callsEl.classList.add('has-feature');
                }
            }
        }

        // Load global price
        async function loadGlobalPrice() {
            const packages = await fetchPackages('global');
            const cheapest = getCheapestPackage(packages);
            const features = getFeatures(packages);

            const priceEl = document.getElementById('price-global');
            const smsEl = document.getElementById('sms-global');
            const callsEl = document.getElementById('calls-global');

            if (priceEl && cheapest) {
                priceEl.innerHTML = `From <strong>$${cheapest.price.toFixed(2)}</strong>`;
            }

            if (smsEl && features.hasText) {
                smsEl.innerHTML = `<span class="check">&#10003;</span> SMS`;
                smsEl.classList.add('has-feature');
            }
            if (callsEl && features.hasVoice) {
                callsEl.innerHTML = `<span class="check">&#10003;</span> Calls`;
                callsEl.classList.add('has-feature');
            }
        }

        // Open country modal
        async function openCountryModal(code, name, flag) {
            currentModalData = { type: 'local', code, name, flag };
            selectedPackage = null;
            showModal(name, flag, 'Loading packages...');

            const packages = await fetchPackages('local', code);
            renderModalPackages(packages, name);
        }

        // Open region modal
        async function openRegionModal(code, name, flag, countries) {
            currentModalData = { type: 'regional', code, name, flag, countries };
            selectedPackage = null;
            showModal(name, flag, countries);

            const packages = await fetchPackages('regional', null, code);
            renderModalPackages(packages, name);
        }

        // Open global modal
        async function openGlobalModal() {
            currentModalData = { type: 'global', name: 'Worldwide', flag: '' };
            selectedPackage = null;
            showModal('Worldwide Coverage', '', '100+ countries');

            const packages = await fetchPackages('global');
            renderModalPackages(packages, 'Worldwide');
        }

        // Show modal
        function showModal(title, flag, subtitle) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSubtitle').textContent = subtitle;
            document.getElementById('modalFlag').src = flag || 'assets/images/globe-icon.png';
            document.getElementById('modalFlag').style.display = flag ? 'block' : 'none';
            document.getElementById('modalBody').innerHTML = `<div class="modal-loading"><div class="spinner"></div><p>Loading packages...</p></div>`;
            document.getElementById('buyNowBtn').disabled = true;
            document.getElementById('buyNowBtn').textContent = 'Select a package';
            document.getElementById('modalControls').style.display = 'none';
            document.getElementById('tripcoinsSection').style.display = 'none';
            document.getElementById('detailModal').classList.add('show');
            document.body.style.overflow = 'hidden';

            // Reset filter/sort state
            currentFilter = 'all';
            currentSort = 'price-asc';
            document.getElementById('sortSelect').value = 'price-asc';
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === 'all');
            });

            // Reset TripCoins state
            usingTripcoins = false;
            tripcoinsToUse = 0;
            document.getElementById('useTripcoins').checked = false;
            document.getElementById('tripcoinsSlider').style.display = 'none';

            // Load user's TripCoins if logged in
            loadUserTripcoins();
        }

        // Load user's TripCoins from Firestore
        async function loadUserTripcoins() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    userTripcoins = 0;
                    return;
                }

                const doc = await firebase.firestore().collection('esimRewards').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userTripcoins = Math.floor(data.totalCredits || 0); // Only whole coins
                    if (userTripcoins >= 1) {
                        document.getElementById('tripcoinsBalance').textContent = userTripcoins.toFixed(0);
                        document.getElementById('tripcoinsSection').style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('Could not load TripCoins:', error);
                userTripcoins = 0;
            }
        }

        // Toggle TripCoins usage
        function toggleTripcoins() {
            usingTripcoins = document.getElementById('useTripcoins').checked;
            document.getElementById('tripcoinsSlider').style.display = usingTripcoins ? 'block' : 'none';

            if (usingTripcoins && selectedPackage) {
                const maxUsable = Math.min(userTripcoins, Math.floor(selectedPackage.price));
                document.getElementById('tripcoinsAmount').max = maxUsable;
                document.getElementById('tripcoinsAmount').min = 1;
                document.getElementById('tripcoinsAmount').value = maxUsable; // Default to max
                document.getElementById('tripcoinsMaxAvailable').textContent = maxUsable;
                updateTripcoinsAmount();
            } else {
                tripcoinsToUse = 0;
                updateBuyButton();
            }
        }

        // Update TripCoins amount from input
        function updateTripcoinsAmount() {
            const input = document.getElementById('tripcoinsAmount');
            let value = parseInt(input.value) || 0;
            const max = parseInt(input.max) || 0;

            // Enforce min/max bounds
            if (value < 1 && value !== 0) value = 1;
            if (value > max) value = max;

            tripcoinsToUse = value;
            document.getElementById('tripcoinsSavings').textContent = tripcoinsToUse.toFixed(2);
            updateBuyButton();
        }

        // Update buy button with final price
        function updateBuyButton() {
            if (!selectedPackage) return;
            const finalPrice = Math.max(0, selectedPackage.price - tripcoinsToUse);
            if (tripcoinsToUse > 0) {
                document.getElementById('buyNowBtn').innerHTML = `Buy Now - <s style="opacity:0.6">$${selectedPackage.price.toFixed(2)}</s> $${finalPrice.toFixed(2)}`;
            } else {
                document.getElementById('buyNowBtn').textContent = `Buy Now - $${selectedPackage.price.toFixed(2)}`;
            }

            // Also update the proceed button in expanded card
            const expandedCard = document.querySelector('.package-option.expanded');
            if (expandedCard) {
                const proceedBtn = expandedCard.querySelector('.proceed-btn');
                if (proceedBtn) {
                    if (tripcoinsToUse > 0) {
                        proceedBtn.innerHTML = `Proceed to Checkout - <s style="opacity:0.6">$${selectedPackage.price.toFixed(2)}</s> $${finalPrice.toFixed(2)}`;
                    } else {
                        proceedBtn.textContent = `Proceed to Checkout - $${selectedPackage.price.toFixed(2)}`;
                    }
                }
            }
        }

        // Set filter
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            applyFilterAndSort();
        }

        // Set sorting
        function setSorting(sort) {
            currentSort = sort;
            applyFilterAndSort();
        }

        // Apply filter and sort to packages
        function applyFilterAndSort() {
            let filtered = [...allPackages];

            // Apply filter
            if (currentFilter === 'unlimited') {
                filtered = filtered.filter(pkg => pkg.isUnlimited);
            } else if (currentFilter === 'standard') {
                filtered = filtered.filter(pkg => !pkg.isUnlimited);
            }

            // Apply sort
            switch (currentSort) {
                case 'price-asc':
                    filtered.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    filtered.sort((a, b) => b.price - a.price);
                    break;
                case 'data-desc':
                    filtered.sort((a, b) => parseDataAmount(b.data) - parseDataAmount(a.data));
                    break;
                case 'days-desc':
                    filtered.sort((a, b) => b.days - a.days);
                    break;
            }

            renderPackagesList(filtered);
        }

        // Parse data amount for sorting (e.g., "1 GB" -> 1, "500 MB" -> 0.5, "Unlimited" -> 9999)
        function parseDataAmount(dataStr) {
            if (!dataStr) return 0;
            const lower = dataStr.toLowerCase();
            if (lower.includes('unlimited')) return 9999;
            const match = lower.match(/(\d+\.?\d*)\s*(gb|mb|tb)/);
            if (!match) return 0;
            const amount = parseFloat(match[1]);
            const unit = match[2];
            if (unit === 'tb') return amount * 1000;
            if (unit === 'gb') return amount;
            if (unit === 'mb') return amount / 1000;
            return 0;
        }

        // Render just the packages list (for filter/sort updates)
        function renderPackagesList(packages) {
            if (!packages || packages.length === 0) {
                document.getElementById('modalBody').innerHTML = `
                    <div class="no-results">
                        <p>No ${currentFilter === 'unlimited' ? 'unlimited' : currentFilter === 'standard' ? 'standard' : ''} packages found.</p>
                        <button class="filter-tab" onclick="setFilter('all')" style="margin-top: 1rem;">Show All Packages</button>
                    </div>
                `;
                return;
            }

            document.getElementById('modalBody').innerHTML = `
                <div class="packages-list">
                    ${packages.map((pkg, i) => `
                        <div class="package-option" onclick="selectPackageOption(${i})" id="pkg-${i}" data-pkg-id="${pkg.id}">
                            <div class="package-header">
                                <div class="package-info">
                                    <div class="package-data-amount">
                                        ${pkg.data}
                                        ${pkg.isUnlimited ? '<span class="unlimited-badge">Unlimited</span>' : ''}
                                    </div>
                                    <div class="package-validity">${pkg.days} days validity</div>
                                    <div class="package-features-mini">
                                        <span class="has">Data</span>
                                        ${pkg.hasText ? '<span class="has">SMS</span>' : ''}
                                        ${pkg.hasVoice ? '<span class="has">Calls</span>' : ''}
                                    </div>
                                </div>
                                <div class="package-price-tag">$${pkg.price.toFixed(2)}</div>
                            </div>
                            <div class="package-details-expanded">
                                <div class="package-detail-row">
                                    <span class="package-detail-label">&#128246; Data</span>
                                    <span class="package-detail-value">${pkg.data}${pkg.isUnlimited ? ' (Unlimited)' : ''}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">&#128241; Provider</span>
                                    <span class="package-detail-value">${pkg.operatorTitle || 'TripPortier eSIM'}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">&#128172; SMS</span>
                                    <span class="package-detail-value ${pkg.hasText ? 'available' : 'unavailable'}">${pkg.hasText ? 'Included' : 'Not included'}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">&#128222; Voice Calls</span>
                                    <span class="package-detail-value ${pkg.hasVoice ? 'available' : 'unavailable'}">${pkg.hasVoice ? 'Included' : 'Not included'}</span>
                                </div>
                                <div class="package-detail-row">
                                    <span class="package-detail-label">&#128197; Validity</span>
                                    <span class="package-detail-value">${pkg.days} days</span>
                                </div>
                                <div class="validity-note">
                                    <p>&#9989; <strong>Activation:</strong> Your ${pkg.days}-day plan starts when you first connect to a network at your destination - not when you install the eSIM.</p>
                                </div>
                                <button class="proceed-btn" onclick="event.stopPropagation(); proceedToPurchase();">
                                    Proceed to Checkout - $${pkg.price.toFixed(2)}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Store filtered packages for selection
            currentModalData.filteredPackages = packages;
        }

        // Render modal packages
        function renderModalPackages(packages, title) {
            allPackages = packages; // Store original list

            const features = getFeatures(packages);
            document.getElementById('modalFeatures').innerHTML = `
                <div class="detail-feature available"><span class="icon">&#128246;</span> Data</div>
                <div class="detail-feature ${features.hasText ? 'available' : 'unavailable'}"><span class="icon">&#128172;</span> SMS</div>
                <div class="detail-feature ${features.hasVoice ? 'available' : 'unavailable'}"><span class="icon">&#128222;</span> Calls</div>
            `;

            if (!packages || packages.length === 0) {
                document.getElementById('modalBody').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <p>No packages available for ${title}.</p>
                    </div>
                `;
                document.getElementById('modalControls').style.display = 'none';
                return;
            }

            // Show controls
            document.getElementById('modalControls').style.display = 'flex';

            // Check if there are unlimited packages
            const hasUnlimited = packages.some(pkg => pkg.isUnlimited);
            const hasStandard = packages.some(pkg => !pkg.isUnlimited);

            // Update filter tabs visibility
            document.querySelectorAll('.filter-tab[data-filter="unlimited"]').forEach(tab => {
                tab.style.display = hasUnlimited ? 'block' : 'none';
            });
            document.querySelectorAll('.filter-tab[data-filter="standard"]').forEach(tab => {
                tab.style.display = hasStandard ? 'block' : 'none';
            });

            // Store packages for selection
            currentModalData.packages = packages;

            // Apply initial sort
            applyFilterAndSort();
        }

        // Select package option
        function selectPackageOption(index) {
            // Use filtered packages if available
            const packages = currentModalData.filteredPackages || currentModalData.packages;
            const clickedElement = document.getElementById(`pkg-${index}`);

            // If clicking on already expanded package, collapse it
            if (clickedElement.classList.contains('expanded')) {
                clickedElement.classList.remove('expanded');
                selectedPackage = null;
                document.getElementById('buyNowBtn').disabled = true;
                document.getElementById('buyNowBtn').textContent = 'Select a package';
                return;
            }

            selectedPackage = packages[index];

            // Update UI - collapse all and expand selected
            document.querySelectorAll('.package-option').forEach((el, i) => {
                el.classList.remove('selected', 'expanded');
                if (i === index) {
                    el.classList.add('expanded');
                }
            });

            // Scroll expanded package into view
            setTimeout(() => {
                clickedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            document.getElementById('buyNowBtn').disabled = false;

            // Update TripCoins slider max value based on selected package
            if (userTripcoins >= 1) {
                const maxUsable = Math.min(userTripcoins, Math.floor(selectedPackage.price));
                document.getElementById('tripcoinsAmount').max = maxUsable;
                document.getElementById('tripcoinsMaxAvailable').textContent = maxUsable;
                if (usingTripcoins) {
                    document.getElementById('tripcoinsAmount').value = Math.min(parseInt(document.getElementById('tripcoinsAmount').value) || 1, maxUsable);
                    updateTripcoinsAmount();
                }
            }

            updateBuyButton();
        }

        // Proceed to purchase - open checkout modal
        function proceedToPurchase() {
            if (!selectedPackage || !currentModalData) return;
            openCheckoutModal();
        }

        // Open checkout modal
        function openCheckoutModal() {
            // Get destination name
            const destinationName = currentModalData.title || currentModalData.name || 'Your Destination';

            // Update package summary
            document.getElementById('checkoutPackageName').textContent =
                `${selectedPackage.data} - ${selectedPackage.days} Days`;
            document.getElementById('checkoutPackageCountry').textContent = destinationName;

            // Calculate final price with TripCoins
            const originalPrice = selectedPackage.price;
            const coinsToUse = usingTripcoins ? tripcoinsToUse : 0;
            const finalPrice = Math.max(0, originalPrice - coinsToUse);

            // Show TripCoins discount if applicable
            if (coinsToUse > 0) {
                document.getElementById('checkoutPackagePrice').innerHTML =
                    `<s style="opacity:0.6">$${originalPrice.toFixed(2)}</s> $${finalPrice.toFixed(2)}`;
                document.getElementById('checkoutTripcoinsAmount').textContent = coinsToUse.toFixed(0);
                document.getElementById('checkoutOriginalPrice').textContent = originalPrice.toFixed(2);
                document.getElementById('checkoutFinalPrice').textContent = finalPrice.toFixed(2);
                document.getElementById('checkoutTripcoinsDiscount').style.display = 'block';
            } else {
                document.getElementById('checkoutPackagePrice').textContent = `$${originalPrice.toFixed(2)}`;
                document.getElementById('checkoutTripcoinsDiscount').style.display = 'none';
            }

            // Pre-fill email if user is logged in
            const currentUser = firebase.auth().currentUser;
            if (currentUser && currentUser.email) {
                document.getElementById('checkoutEmailInput').value = currentUser.email;
            }

            // Show earnings UI
            if (finalPrice > 0) {
                const guestEarnings = finalPrice * 0.03;
                if (currentUser) {
                    // Calculate user's actual earnings (would need level data)
                    const userEarnings = finalPrice * 0.03; // Default to 3% for now
                    document.getElementById('checkoutEarnAmount').textContent = userEarnings.toFixed(2);
                    document.getElementById('checkoutEarnPercent').textContent = '3%';
                    document.getElementById('checkoutUserLevel').textContent = 'Explorer';
                    document.getElementById('checkoutTripcoinsEarnings').style.display = 'block';
                    document.getElementById('checkoutTripcoinsGuest').style.display = 'none';
                } else {
                    document.getElementById('checkoutEarnAmountGuest').textContent = guestEarnings.toFixed(2);
                    document.getElementById('checkoutTripcoinsGuest').style.display = 'block';
                    document.getElementById('checkoutTripcoinsEarnings').style.display = 'none';
                }
            } else {
                document.getElementById('checkoutTripcoinsEarnings').style.display = 'none';
                document.getElementById('checkoutTripcoinsGuest').style.display = 'none';
            }

            // Show the modal
            document.getElementById('checkoutModal').classList.add('show');
        }

        // Close checkout modal
        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('show');
        }

        // Close checkout modal on outside click
        document.getElementById('checkoutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCheckoutModal();
            }
        });

        // Proceed to Stripe checkout
        async function proceedToStripeCheckout() {
            const email = document.getElementById('checkoutEmailInput').value;
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            if (!selectedPackage || !currentModalData) {
                alert('Please select a package first');
                return;
            }

            // Calculate final amount with TripCoins discount
            const coinsToUse = usingTripcoins ? tripcoinsToUse : 0;
            const finalPrice = Math.max(0, selectedPackage.price - coinsToUse);
            const amountInCents = Math.round(finalPrice * 100);

            // Minimum charge is 50 cents for Stripe
            if (amountInCents < 50 && amountInCents > 0) {
                alert('The minimum payment amount is $0.50. Please adjust your TripCoins usage.');
                return;
            }

            // Disable button and show loading state
            const btn = document.getElementById('checkoutBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Processing...';
            btn.disabled = true;

            try {
                // If fully covered by TripCoins, handle differently
                if (amountInCents === 0) {
                    alert('Free orders with TripCoins are processed in the app. Please use the TripPortier app for this purchase.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                // Get destination info
                const countryCode = currentModalData.code || '';
                const countryTitle = currentModalData.title || currentModalData.name || '';

                // Calculate TripCoins to earn (default 3%)
                const tripcoinsToEarn = finalPrice * 0.03;

                // Call Firebase function to create checkout session
                const response = await fetch(`${API_URL}/createEsimCheckout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        packageId: selectedPackage.id,
                        packageName: `${selectedPackage.data} - ${selectedPackage.days} Days`,
                        amount: amountInCents,
                        currency: 'USD',
                        countryCode: countryCode,
                        countryTitle: countryTitle,
                        data: selectedPackage.data,
                        days: selectedPackage.days,
                        operatorTitle: selectedPackage.operatorTitle || 'TripPortier eSIM',
                        tripcoinsUsed: coinsToUse,
                        originalPrice: selectedPackage.price,
                        tripcoinsToEarn: tripcoinsToEarn,
                        language: currentLanguage || 'en',
                    }),
                });

                const data = await response.json();

                if (data.success && data.url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } else {
                    alert(data.error || 'Failed to create checkout session. Please try again.');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('An error occurred. Please try again.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Close detail modal
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Close on outside click
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailModal();
            }
        });

        // Search functionality
        const searchInput = document.getElementById('countrySearch');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();

            if (query.length < 2) {
                searchResults.classList.remove('show');
                return;
            }

            const matches = allCountries.filter(c =>
                c.name.toLowerCase().includes(query) ||
                c.code.toLowerCase() === query
            ).slice(0, 8);

            if (matches.length > 0) {
                searchResults.innerHTML = matches.map(c => `
                    <div class="search-result-item" onclick="openCountryModal('${c.code}', '${c.name}', '${c.flag}')">
                        <img src="${c.flag}" alt="${c.name}">
                        <span>${c.name}</span>
                    </div>
                `).join('');
                searchResults.classList.add('show');
            } else {
                searchResults.classList.remove('show');
            }
        });

        // Close search on click outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('show');
            }
        });

        function performSearch() {
            const query = searchInput.value.toLowerCase().trim();
            const match = allCountries.find(c =>
                c.name.toLowerCase() === query ||
                c.code.toLowerCase() === query
            );
            if (match) {
                openCountryModal(match.code, match.name, match.flag);
            }
        }

        // FAQ toggle
        function toggleFaq(element) {
            const faqItem = element.parentElement;
            faqItem.classList.toggle('open');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderGrid('popular');
        });
    </script>
</body>
</html>
