<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/cookie-consent.css">
    <script src="js/cookie-consent.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripPortier Admin</title>
    <style>
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f5f5f7; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #1a1a1a; margin-bottom: 8px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        textarea { min-height: 100px; resize: vertical; }
        input:focus, textarea:focus { outline: none; border-color: #6366f1; }
        .btn { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .result { margin-top: 20px; padding: 16px; border-radius: 8px; display: none; }
        .result.success { background: #dcfce7; color: #166534; }
        .result.error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #92400e; font-size: 14px; }
        .stats { display: flex; gap: 20px; margin-top: 10px; }
        .stat { background: #f3f4f6; padding: 12px 16px; border-radius: 8px; flex: 1; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: #6366f1; }
        .stat-label { font-size: 12px; color: #666; }

        /* Tab Navigation */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; color: #666; transition: all 0.2s; }
        .tab:hover { background: #f3f4f6; }
        .tab.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Feature Requests */
        .feature-item { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .feature-item.pending { border-left: 4px solid #f59e0b; }
        .feature-item.approved { border-left: 4px solid #10b981; }
        .feature-item.rejected { border-left: 4px solid #ef4444; }
        .feature-item.implemented { border-left: 4px solid #6366f1; }
        .feature-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .feature-title { font-weight: 600; color: #1a1a1a; margin: 0; }
        .feature-category { display: inline-block; background: #f3f4f6; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #666; }
        .feature-description { color: #4b5563; font-size: 14px; line-height: 1.5; margin: 8px 0; }
        .feature-meta { display: flex; gap: 16px; font-size: 12px; color: #9ca3af; margin-bottom: 12px; }
        .feature-actions { display: flex; gap: 8px; }
        .btn-small { padding: 8px 16px; font-size: 13px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-approve { background: #10b981; color: white; }
        .btn-reject { background: #ef4444; color: white; }
        .btn-implement { background: #6366f1; color: white; }
        .btn-small:hover { opacity: 0.9; }
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; }
        .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; background: #ef4444; color: white; font-size: 11px; font-weight: 700; border-radius: 10px; margin-left: 8px; padding: 0 6px; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .filter-tab { padding: 6px 14px; background: #f3f4f6; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; color: #666; }
        .filter-tab.active { background: #1a1a1a; color: white; }
        .votes-display { display: flex; align-items: center; gap: 12px; font-size: 13px; }
        .votes-display .upvotes { color: #10b981; }
        .votes-display .downvotes { color: #ef4444; }

        /* Login Screen */
        .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f5f7; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-overlay.hidden { display: none; }
        .login-card { background: white; border-radius: 16px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 90%; text-align: center; }
        .login-card h1 { margin: 0 0 8px 0; font-size: 28px; }
        .login-card .subtitle { margin-bottom: 32px; }
        .login-card .form-group { text-align: left; }
        .login-error { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none; font-size: 14px; }
        .main-content { display: none; }
        .main-content.visible { display: block; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: #f3f4f6; border: none; padding: 10px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; color: #666; }
        .logout-btn:hover { background: #e5e7eb; }

        /* Target Selector */
        .target-selector { display: flex; gap: 12px; flex-wrap: wrap; }
        .target-option { flex: 1; min-width: 120px; }
        .target-option input { display: none; }
        .target-label { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; background: white; }
        .target-label:hover { border-color: #a5b4fc; background: #f5f3ff; }
        .target-option input:checked + .target-label { border-color: #6366f1; background: #eef2ff; }
        .target-icon { font-size: 20px; }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Login Screen -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h1>TripPortier Admin</h1>
            <p class="subtitle">Enter your admin key to continue</p>
            <div id="loginError" class="login-error"></div>
            <div class="form-group">
                <label for="loginKey">Admin Key</label>
                <input type="password" id="loginKey" placeholder="Enter admin key" onkeypress="if(event.key==='Enter')login()">
            </div>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">Logout</button>

    <div class="container main-content" id="mainContent">
        <h1>TripPortier Admin</h1>
        <p class="subtitle">Manage notifications and feature requests</p>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('notifications')">Push Notifications</button>
            <button class="tab" onclick="switchTab('features')">Feature Requests <span id="pendingBadge" class="badge" style="display: none;">0</span></button>
        </div>

        <!-- Push Notifications Tab -->
        <div id="notifications-tab" class="tab-content active">
            <div class="card">
                <div class="form-group">
                    <label for="title">Notification Title</label>
                    <input type="text" id="title" placeholder="e.g., Holiday Special!">
                </div>

                <div class="form-group">
                    <label for="body">Message</label>
                    <textarea id="body" placeholder="e.g., Get 20% off all eSIMs this week!"></textarea>
                </div>

                <div class="form-group">
                    <label for="target">Send To</label>
                    <div class="target-selector">
                        <label class="target-option">
                            <input type="radio" name="target" value="phone" checked>
                            <span class="target-label">
                                <span class="target-icon">üì±</span>
                                Phone App
                            </span>
                        </label>
                        <label class="target-option">
                            <input type="radio" name="target" value="web">
                            <span class="target-label">
                                <span class="target-icon">üíª</span>
                                Web Browser
                            </span>
                        </label>
                        <label class="target-option">
                            <input type="radio" name="target" value="both">
                            <span class="target-label">
                                <span class="target-icon">üì≤</span>
                                Both
                            </span>
                        </label>
                    </div>
                </div>

                <button class="btn" onclick="sendNotification()">
                    Send Notification
                </button>

                <div id="result" class="result"></div>
            </div>

            <div class="card">
                <h3 style="margin-top: 0;">Tips</h3>
                <ul style="color: #666; line-height: 1.8;">
                    <li>Keep titles short (under 50 characters)</li>
                    <li>Messages should be clear and actionable</li>
                    <li>Best times: 10am-12pm or 6pm-8pm local time</li>
                    <li>Don't spam - users will disable notifications</li>
                </ul>
            </div>
        </div>

        <!-- Feature Requests Tab -->
        <div id="features-tab" class="tab-content">
            <div class="card">
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterFeatures('pending')">Pending</button>
                    <button class="filter-tab" onclick="filterFeatures('approved')">Approved</button>
                    <button class="filter-tab" onclick="filterFeatures('rejected')">Rejected</button>
                    <button class="filter-tab" onclick="filterFeatures('implemented')">Implemented</button>
                    <button class="filter-tab" onclick="filterFeatures('all')">All</button>
                </div>

                <div id="features-list">
                    <div class="empty-state">Loading feature requests...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDG-hBY3B8wFYiB1z4oIHHgTzx50Ric6R0",
            authDomain: "tripportier.firebaseapp.com",
            projectId: "tripportier",
            storageBucket: "tripportier.firebasestorage.app",
            messagingSenderId: "498498781854",
            appId: "1:498498781854:web:3c9f1b88be9cb2f1c7a16c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const API_URL = 'https://us-central1-tripportier.cloudfunctions.net';

        // State
        let allFeatures = [];
        let currentFilter = 'pending';
        let adminKey = '';

        // Login function - validates admin key with server
        async function login() {
            const loginKeyInput = document.getElementById('loginKey');
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.querySelector('.login-card .btn');
            const key = loginKeyInput.value.trim();

            if (!key) {
                errorDiv.textContent = 'Please enter your admin key';
                errorDiv.style.display = 'block';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Verifying...';
            errorDiv.style.display = 'none';

            try {
                // Validate the key by making a request to the admin endpoint
                const response = await fetch(`${API_URL}/getFeatureRequests`, {
                    method: 'GET',
                    headers: {
                        'X-Admin-Key': key
                    }
                });

                if (response.ok) {
                    // Key is valid - store it and show main content
                    adminKey = key;
                    sessionStorage.setItem('adminKey', key);
                    showMainContent();
                } else if (response.status === 401) {
                    errorDiv.textContent = 'Invalid admin key';
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.textContent = 'Authentication failed. Please try again.';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.style.display = 'block';
            }

            loginBtn.disabled = false;
            loginBtn.textContent = 'Login';
        }

        // Logout function
        function logout() {
            adminKey = '';
            sessionStorage.removeItem('adminKey');
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('visible');
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('loginKey').value = '';
        }

        // Show main content after successful login
        function showMainContent() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainContent').classList.add('visible');
            document.getElementById('logoutBtn').style.display = 'block';
            loadFeatures();
        }

        // Check for existing session on page load
        function checkSession() {
            const savedKey = sessionStorage.getItem('adminKey');
            if (savedKey) {
                adminKey = savedKey;
                showMainContent();
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'features') {
                loadFeatures();
            }
        }

        // Load feature requests from Firestore
        async function loadFeatures() {
            try {
                const snapshot = await db.collection('featureRequests')
                    .orderBy('submittedAt', 'desc')
                    .get();

                allFeatures = [];
                snapshot.forEach(doc => {
                    allFeatures.push({ id: doc.id, ...doc.data() });
                });

                // Update pending badge
                const pendingCount = allFeatures.filter(f => f.status === 'pending').length;
                const badge = document.getElementById('pendingBadge');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }

                renderFeatures();
            } catch (error) {
                console.error('Error loading features:', error);
                document.getElementById('features-list').innerHTML =
                    '<div class="empty-state">Error loading features. Check console.</div>';
            }
        }

        // Filter features
        function filterFeatures(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="filterFeatures('${status}')"]`).classList.add('active');
            renderFeatures();
        }

        // Render features list
        function renderFeatures() {
            const container = document.getElementById('features-list');
            let filtered = currentFilter === 'all'
                ? allFeatures
                : allFeatures.filter(f => f.status === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state">No ${currentFilter} feature requests</div>`;
                return;
            }

            container.innerHTML = filtered.map(feature => {
                const date = feature.submittedAt?.toDate?.()
                    ? feature.submittedAt.toDate().toLocaleDateString()
                    : 'Unknown date';

                const upvotes = feature.upvotes || 0;
                const downvotes = feature.downvotes || 0;

                let actions = '';
                if (feature.status === 'pending') {
                    actions = `
                        <button class="btn-small btn-approve" onclick="updateStatus('${feature.id}', 'approved')">Approve</button>
                        <button class="btn-small btn-reject" onclick="updateStatus('${feature.id}', 'rejected')">Reject</button>
                    `;
                } else if (feature.status === 'approved') {
                    actions = `
                        <button class="btn-small btn-implement" onclick="updateStatus('${feature.id}', 'implemented')">Mark Implemented</button>
                        <button class="btn-small btn-reject" onclick="updateStatus('${feature.id}', 'rejected')">Reject</button>
                    `;
                } else if (feature.status === 'rejected') {
                    actions = `
                        <button class="btn-small btn-approve" onclick="updateStatus('${feature.id}', 'approved')">Approve</button>
                    `;
                } else if (feature.status === 'implemented') {
                    actions = `<span style="color: #6366f1; font-weight: 600;">‚úì Implemented</span>`;
                }

                return `
                    <div class="feature-item ${feature.status}">
                        <div class="feature-header">
                            <h4 class="feature-title">${escapeHtml(feature.title)}</h4>
                            <span class="feature-category">${escapeHtml(feature.category || 'General')}</span>
                        </div>
                        <p class="feature-description">${escapeHtml(feature.description)}</p>
                        <div class="feature-meta">
                            <span>Submitted: ${date}</span>
                            ${feature.email ? `<span>Email: ${escapeHtml(feature.email)}</span>` : ''}
                            <div class="votes-display">
                                <span class="upvotes">üëç ${upvotes}</span>
                                <span class="downvotes">üëé ${downvotes}</span>
                            </div>
                        </div>
                        <div class="feature-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update feature status via secure Cloud Function
        async function updateStatus(featureId, newStatus) {
            if (!adminKey) {
                alert('Session expired. Please login again.');
                logout();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/updateFeatureRequestStatus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify({ featureId, status: newStatus })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('Session expired. Please login again.');
                        logout();
                    } else {
                        alert(data.error || 'Failed to update status');
                    }
                    return;
                }

                // Update local state
                const feature = allFeatures.find(f => f.id === featureId);
                if (feature) {
                    feature.status = newStatus;
                }

                // Update pending badge
                const pendingCount = allFeatures.filter(f => f.status === 'pending').length;
                const badge = document.getElementById('pendingBadge');
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }

                renderFeatures();
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Check console.');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Push notification function
        async function sendNotification() {
            if (!adminKey) {
                alert('Session expired. Please login again.');
                logout();
                return;
            }

            const title = document.getElementById('title').value.trim();
            const body = document.getElementById('body').value.trim();
            const target = document.querySelector('input[name="target"]:checked').value;
            const resultDiv = document.getElementById('result');
            const btn = document.querySelector('#notifications-tab .btn');

            if (!title || !body) {
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
                resultDiv.textContent = 'Please enter both title and message';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Sending...';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/sendBroadcastNotification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify({ title, body, target })
                });

                const data = await response.json();

                if (response.status === 401) {
                    alert('Session expired. Please login again.');
                    logout();
                    return;
                }

                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    const targetLabel = target === 'phone' ? 'Phone' : target === 'web' ? 'Web' : 'Phone & Web';
                    resultDiv.innerHTML = `
                        <strong>Notification sent to ${targetLabel}!</strong>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">${data.sent || 0}</div>
                                <div class="stat-label">Delivered</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${data.failed || 0}</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${data.total || 0}</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        </div>
                    `;
                    // Clear form
                    document.getElementById('title').value = '';
                    document.getElementById('body').value = '';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = data.error || 'Failed to send notification';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error: ' + error.message;
            }

            resultDiv.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Send Notification';
        }

        // Check session on page load
        checkSession();
    </script>
</body>
</html>
